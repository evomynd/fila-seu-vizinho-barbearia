<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seu Vizinho - Fila</title>
  <meta name="application-name" content="Seu Vizinho">
  <meta name="apple-mobile-web-app-title" content="Seu Vizinho">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#151b29">
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" type="image/png" href="https://github.com/evomynd/fila-seu-vizinho-barbearia/blob/main/icons/icon-512x512.png?raw=true">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; background-color: #cdc8c0; }
    .zele-primary { background-color: #151b29; }
    .zele-btn { background-color: #151b29; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 1px solid #e5e5e5; transition: all .2s ease; }
    .zele-btn:hover { background-color: #1f2937; transform: translateY(-2px); }
    .card { background: white; border: 2px solid #e5e5e5; box-shadow: 0 8px 16px rgba(0,0,0,0.15); }
    .modal-overlay { display:none; position:fixed; inset:0; background-color: rgba(0,0,0,.5); z-index: 9999; align-items:center; justify-content:center; }
    .modal-overlay.show { display:flex; }
  </style>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, updateProfile } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, query, where, orderBy, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCyTJVlgvkLa2-SUNaxAlOiTezcXfjiP64",
      authDomain: "seu-vizinho-barbearia.firebaseapp.com",
      projectId: "seu-vizinho-barbearia",
      storageBucket: "seu-vizinho-barbearia.firebasestorage.app",
      messagingSenderId: "25346983688",
      appId: "1:25346983688:web:727308786e34874ae50ebd"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });

    let currentUser = null;
    let selectedBarber = null;
    let selectedDate = null;
    let selectedTime = null;
    let editingBarberId = null;
    let currentBarberAvailability = null;
    let currentQueueId = null;
    let queueListener = null;

    function getTodayInSaoPaulo() {
      const now = new Date();
      const saoPauloTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' }));
      return saoPauloTime.toISOString().split('T')[0];
    }

    function getTomorrowInSaoPaulo() {
      const now = new Date();
      const saoPauloTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' }));
      saoPauloTime.setDate(saoPauloTime.getDate() + 1);
      
      // Se amanh√£ for domingo (0), pula para segunda (1)
      if (saoPauloTime.getDay() === 0) {
        saoPauloTime.setDate(saoPauloTime.getDate() + 1);
      }
      
      return saoPauloTime.toISOString().split('T')[0];
    }

    function getAllowedDates() {
      return [getTodayInSaoPaulo(), getTomorrowInSaoPaulo()];
    }

    const els = {
      loading: document.getElementById('loading-screen'),
      login: document.getElementById('auth-screen'),
      app: document.getElementById('app-container'),
      googleBtn: document.getElementById('google-login-btn'),
      showEmailBtn: document.getElementById('show-email-login'),
      emailModal: document.getElementById('email-login-modal'),
      closeEmailModal: document.getElementById('close-email-modal'),
      emailLoginForm: document.getElementById('email-login-form'),
      emailSignupForm: document.getElementById('email-signup-form'),
      emailResetForm: document.getElementById('email-reset-form'),
      showSignupLink: document.getElementById('show-signup'),
      showLoginLink: document.getElementById('show-login'),
      showResetLink: document.getElementById('show-reset'),
      loginEmail: document.getElementById('login-email'),
      loginPassword: document.getElementById('login-password'),
      loginBtn: document.getElementById('login-btn'),
      signupName: document.getElementById('signup-name'),
      signupEmail: document.getElementById('signup-email'),
      signupPassword: document.getElementById('signup-password'),
      signupBtn: document.getElementById('signup-btn'),
      resetEmail: document.getElementById('reset-email'),
      resetBtn: document.getElementById('reset-btn'),
      authError: document.getElementById('auth-error'),
      userName: document.getElementById('user-name'),
      userEmail: document.getElementById('user-email'),
      userPhoto: document.getElementById('user-photo'),
      barberBtns: document.querySelectorAll('.barber-btn'),
      dateInput: document.getElementById('date-input'),
      timeInput: document.getElementById('time-input'),
      queueInfo: document.getElementById('queue-info'),
      joinQueueBtn: document.getElementById('join-queue-btn'),
      otherDateBtn: document.getElementById('other-date-btn'),
      ringModal: document.getElementById('ring-modal'),
      ringNumber: document.getElementById('ring-number'),
      leaveQueueBtn: document.getElementById('leave-queue-btn'),
      menuBtn: document.getElementById('menu-btn'),
      menuOverlay: document.getElementById('menu-overlay'),
      menuDrawer: document.getElementById('menu-drawer'),
      menuCloseBtn: document.getElementById('menu-close-btn'),
      adminBtn: document.getElementById('menu-admin-btn'),
      adminPage: document.getElementById('admin-page'),
      backFromAdmin: document.getElementById('back-from-admin'),
      adminBarberList: document.getElementById('admin-barber-list'),
      adminAddBarberBtn: document.getElementById('admin-add-barber-btn'),
      adminBarberName: document.getElementById('admin-barber-name'),
      adminAvailabilityBtn: document.getElementById('admin-availability-btn'),
      availabilityModal: document.getElementById('availability-modal'),
      closeAvailabilityModal: document.getElementById('close-availability-modal'),
      availBarberName: document.getElementById('avail-barber-name'),
      availDays: document.getElementById('avail-days'),
      availStartTime: document.getElementById('avail-start-time'),
      availEndTime: document.getElementById('avail-end-time'),
      saveAvailabilityBtn: document.getElementById('save-availability-btn')
    };

      // Elementos do modal de fila admin
      els.adminQueueModal = document.getElementById('admin-queue-modal');
      els.closeAdminQueueModal = document.getElementById('close-admin-queue-modal');
      els.adminQueueList = document.getElementById('admin-queue-list');

    function showLoading() { els.loading.style.display = 'flex'; els.login.classList.add('hidden'); els.app.classList.add('hidden'); }
    function showLogin() { els.loading.style.display = 'none'; els.login.classList.remove('hidden'); els.app.classList.add('hidden'); }
    function showApp() { els.loading.style.display = 'none'; els.login.classList.add('hidden'); els.app.classList.remove('hidden'); }

    els.googleBtn?.addEventListener('click', async () => {
      try { showLoading(); const res = await signInWithPopup(auth, provider); currentUser = res.user; await ensureUserDoc(currentUser); } catch(e){ console.error(e); showLogin(); }
    });

    els.showEmailBtn?.addEventListener('click', () => {
      els.emailModal.classList.add('show');
      showEmailForm('login');
    });

    els.closeEmailModal?.addEventListener('click', () => els.emailModal.classList.remove('show'));

    els.showSignupLink?.addEventListener('click', (e) => { e.preventDefault(); showEmailForm('signup'); });
    els.showLoginLink?.addEventListener('click', (e) => { e.preventDefault(); showEmailForm('login'); });
    els.showResetLink?.addEventListener('click', (e) => { e.preventDefault(); showEmailForm('reset'); });

    function showEmailForm(type) {
      els.emailLoginForm.classList.add('hidden');
      els.emailSignupForm.classList.add('hidden');
      els.emailResetForm.classList.add('hidden');
      els.authError.textContent = '';
      if (type === 'login') els.emailLoginForm.classList.remove('hidden');
      else if (type === 'signup') els.emailSignupForm.classList.remove('hidden');
      else if (type === 'reset') els.emailResetForm.classList.remove('hidden');
    }

    els.loginBtn?.addEventListener('click', async () => {
      const email = els.loginEmail.value.trim();
      const password = els.loginPassword.value;
      if (!email || !password) { els.authError.textContent = 'Preencha todos os campos.'; return; }
      try {
        els.authError.textContent = '';
        els.loginBtn.disabled = true;
        els.loginBtn.textContent = 'Entrando...';
        await signInWithEmailAndPassword(auth, email, password);
        els.emailModal.classList.remove('show');
      } catch(e) {
        els.authError.textContent = e.code === 'auth/wrong-password' ? 'Senha incorreta.' : e.code === 'auth/user-not-found' ? 'Usu√°rio n√£o encontrado.' : 'Erro ao entrar.';
      } finally {
        els.loginBtn.disabled = false;
        els.loginBtn.textContent = 'Entrar';
      }
    });

    els.signupBtn?.addEventListener('click', async () => {
      const name = els.signupName.value.trim();
      const email = els.signupEmail.value.trim();
      const password = els.signupPassword.value;
      if (!name || !email || !password) { els.authError.textContent = 'Preencha todos os campos.'; return; }
      if (password.length < 6) { els.authError.textContent = 'Senha deve ter no m√≠nimo 6 caracteres.'; return; }
      try {
        els.authError.textContent = '';
        els.signupBtn.disabled = true;
        els.signupBtn.textContent = 'Criando...';
        const res = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(res.user, { displayName: name });
        await ensureUserDoc(res.user);
        els.emailModal.classList.remove('show');
      } catch(e) {
        els.authError.textContent = e.code === 'auth/email-already-in-use' ? 'Email j√° cadastrado.' : e.code === 'auth/invalid-email' ? 'Email inv√°lido.' : 'Erro ao criar conta.';
      } finally {
        els.signupBtn.disabled = false;
        els.signupBtn.textContent = 'Criar Conta';
      }
    });

    els.resetBtn?.addEventListener('click', async () => {
      const email = els.resetEmail.value.trim();
      if (!email) { els.authError.textContent = 'Digite seu email.'; return; }
      try {
        els.authError.textContent = '';
        els.resetBtn.disabled = true;
        els.resetBtn.textContent = 'Enviando...';
        await sendPasswordResetEmail(auth, email);
        els.authError.textContent = 'Email de recupera√ß√£o enviado! Verifique sua caixa de entrada.';
        els.authError.style.color = 'green';
        setTimeout(() => { showEmailForm('login'); els.authError.style.color = ''; }, 3000);
      } catch(e) {
        els.authError.textContent = e.code === 'auth/user-not-found' ? 'Email n√£o encontrado.' : 'Erro ao enviar email.';
      } finally {
        els.resetBtn.disabled = false;
        els.resetBtn.textContent = 'Enviar Link';
      }
    });

    onAuthStateChanged(auth, async (user) => {
      if (user) { currentUser = user; await ensureUserDoc(user); updateUserUI(user); loadBarbers(); showApp(); } else { showLogin(); }
    });

    async function ensureUserDoc(user){
      const ref = doc(db, 'users', user.uid);
      const snap = await getDoc(ref);
      const base = { email: user.email, displayName: user.displayName || user.email.split('@')[0], role: 'user', createdAt: new Date().toISOString() };
      if (!snap.exists()) await setDoc(ref, base);
      else await setDoc(ref, { lastLogin: new Date().toISOString() }, { merge: true });
    }

    function updateUserUI(user){
      const defaultPhoto = 'https://github.com/evomynd/fila-seu-vizinho-barbearia/blob/main/icons/icon-512x512.png?raw=true';
      els.userName.textContent = user.displayName || 'Usu√°rio';
      els.userEmail.textContent = user.email;
      els.userPhoto.src = user.photoURL || defaultPhoto;
    }

    function openMenu(){ els.menuOverlay.classList.add('show'); els.menuDrawer.classList.add('show'); }
    function closeMenu(){ els.menuOverlay.classList.remove('show'); els.menuDrawer.classList.remove('show'); }
    els.menuBtn?.addEventListener('click', openMenu);
    els.menuCloseBtn?.addEventListener('click', closeMenu);
    els.menuOverlay?.addEventListener('click', closeMenu);

      // Bot√£o para abrir modal de fila admin
      const adminQueueBtn = document.createElement('button');
      adminQueueBtn.id = 'menu-queue-btn';
      adminQueueBtn.className = 'w-full p-3 border rounded-lg text-left hover:bg-gray-50';
      adminQueueBtn.textContent = 'üë• Fila de clientes';
      adminQueueBtn.addEventListener('click', () => {
        closeMenu();
        showAdminQueueModal();
      });
      document.getElementById('menu-drawer').querySelector('.space-y-2').appendChild(adminQueueBtn);

    els.adminBtn?.addEventListener('click', () => { closeMenu(); els.app.classList.add('hidden'); els.adminPage.classList.remove('hidden'); loadAdminBarbers(); });
    els.backFromAdmin?.addEventListener('click', () => { els.adminPage.classList.add('hidden'); els.app.classList.remove('hidden'); });

    async function loadAdminBarbers(){
      els.adminBarberList.innerHTML = '';
      const qRef = query(collection(db, 'barbers'), orderBy('name'));
      onSnapshot(qRef, (snap) => {
        els.adminBarberList.innerHTML = '';
        snap.forEach(docu => {
          const d = docu.data();
          const li = document.createElement('div');
          li.className = 'flex items-center justify-between p-3 border rounded-lg';
          const availText = d.availability ? `${d.availability.days?.length || 0} dias` : 'N√£o configurado';
          li.innerHTML = `
            <div>
              <span class="font-semibold">${d.name}</span>
              <p class="text-xs text-gray-500">Disponibilidade: ${availText}</p>
            </div>
            <button class="text-blue-600 hover:text-blue-800 text-sm font-semibold" onclick="window.editBarberAvailability('${docu.id}', '${d.name}')">Editar</button>
          `;
          els.adminBarberList.appendChild(li);
        });
      });
    }

    window.editBarberAvailability = async (barberId, barberName) => {
      editingBarberId = barberId;
      els.availBarberName.textContent = barberName;
      const barberDoc = await getDoc(doc(db, 'barbers', barberId));
      const data = barberDoc.data();
      const avail = data.availability || { days: [], startTime: '09:00', endTime: '18:00' };
      
      document.querySelectorAll('.day-checkbox').forEach(cb => {
        cb.checked = avail.days?.includes(cb.value) || false;
      });
      els.availStartTime.value = avail.startTime || '09:00';
      els.availEndTime.value = avail.endTime || '18:00';
      
      els.availabilityModal.classList.add('show');
    };

    els.closeAvailabilityModal?.addEventListener('click', () => els.availabilityModal.classList.remove('show'));

    els.saveAvailabilityBtn?.addEventListener('click', async () => {
      if (!editingBarberId) return;
      const selectedDays = Array.from(document.querySelectorAll('.day-checkbox:checked')).map(cb => cb.value);
      const startTime = els.availStartTime.value;
      const endTime = els.availEndTime.value;
      
      if (selectedDays.length === 0) {
        alert('Selecione pelo menos um dia.');
        return;
      }
      
      try {
        await updateDoc(doc(db, 'barbers', editingBarberId), {
          availability: { days: selectedDays, startTime, endTime }
        });
        els.availabilityModal.classList.remove('show');
        editingBarberId = null;
      } catch(e) {
        console.error(e);
        alert('Erro ao salvar disponibilidade.');
      }
    });

      // Fun√ß√£o para mostrar modal de fila admin
      async function showAdminQueueModal() {
        els.adminQueueModal.classList.add('show');
        els.adminQueueList.innerHTML = '<div class="text-center text-gray-500">Carregando fila...</div>';
        // Busca todos os clientes na fila, ordenados por data/hora de inclus√£o
        const today = getTodayInSaoPaulo();
        const qRef = query(collection(db, 'queues'), where('date', '==', today), orderBy('createdAt'));
        onSnapshot(qRef, (snap) => {
          if (snap.empty) {
            els.adminQueueList.innerHTML = '<div class="text-center text-gray-500">Nenhum cliente na fila.</div>';
            return;
          }
          els.adminQueueList.innerHTML = '';
          snap.forEach(docu => {
            const d = docu.data();
            const card = document.createElement('div');
            card.className = 'card p-4 mb-3 flex items-center justify-between';
            card.innerHTML = `
              <div>
                <div class="font-bold text-lg">${d.userName}</div>
                <div class="text-sm text-gray-600">Barbeiro: ${d.barberId} | Hor√°rio: ${d.time}</div>
              </div>
              <button class="bg-green-600 hover:bg-green-700 text-white font-bold px-4 py-2 rounded-lg" data-checkin="${docu.id}">Check-in</button>
            `;
            els.adminQueueList.appendChild(card);
          });
          // Adiciona event listeners para check-in
          els.adminQueueList.querySelectorAll('button[data-checkin]').forEach(btn => {
            btn.addEventListener('click', async () => {
              const id = btn.getAttribute('data-checkin');
              btn.disabled = true;
              btn.textContent = 'Confirmando...';
              const { deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
              await deleteDoc(doc(db, 'queues', id));
            });
          });
        });
      }

      els.closeAdminQueueModal?.addEventListener('click', () => {
        els.adminQueueModal.classList.remove('show');
        els.adminQueueList.innerHTML = '';
      });

    els.adminAddBarberBtn?.addEventListener('click', async () => {
      const name = els.adminBarberName.value.trim();
      if (!name) return;
      await addDoc(collection(db, 'barbers'), { name, createdAt: new Date().toISOString() });
      els.adminBarberName.value = '';
    });

    async function loadBarbers(){
      const barberContainer = document.querySelector('.grid.grid-cols-1.sm\\:grid-cols-3');
      if (!barberContainer) return;
      barberContainer.innerHTML = '<p class="col-span-3 text-center text-gray-600">Carregando barbeiros...</p>';
      
      const qRef = query(collection(db, 'barbers'), orderBy('name'));
      onSnapshot(qRef, (snap) => {
        barberContainer.innerHTML = '';
        if (snap.empty) {
          barberContainer.innerHTML = '<p class="col-span-3 text-center text-gray-600">Nenhum barbeiro cadastrado. Use o menu Admin.</p>';
          return;
        }
        snap.forEach(docu => {
          const d = docu.data();
          const btn = document.createElement('button');
          btn.className = 'barber-btn zele-btn rounded-lg py-6 text-lg font-bold';
          btn.dataset.barberId = docu.id;
          btn.textContent = d.name;
          btn.addEventListener('click', async () => {
            document.querySelectorAll('.barber-btn').forEach(b => b.classList.remove('ring-4'));
            btn.classList.add('ring-4');
            selectedBarber = docu.id;
            currentBarberAvailability = d.availability || null;
            validateAndUpdateDateInput();
            updateQueuePreview();
          });
          barberContainer.appendChild(btn);
        });
      });
    }

    function validateAndUpdateDateInput() {
      const allowedDates = getAllowedDates();
      const today = allowedDates[0];
      const tomorrow = allowedDates[1];
      
      els.dateInput.disabled = false;
      els.dateInput.min = today;
      els.dateInput.max = tomorrow;
      
      if (selectedDate) {
        // Verifica se a data est√° dentro dos dias permitidos (hoje ou amanh√£)
        if (!allowedDates.includes(selectedDate)) {
          els.queueInfo.textContent = 'Apenas hoje e amanh√£ s√£o permitidos.';
          els.joinQueueBtn.disabled = true;
          selectedDate = null;
          els.dateInput.value = '';
          return;
        }
        
        // Verifica disponibilidade do barbeiro
        if (currentBarberAvailability && currentBarberAvailability.days && currentBarberAvailability.days.length > 0) {
          const dayOfWeek = new Date(selectedDate + 'T00:00:00').getDay().toString();
          if (!currentBarberAvailability.days.includes(dayOfWeek)) {
            els.queueInfo.textContent = 'Este barbeiro n√£o trabalha neste dia. Escolha outra data.';
            els.joinQueueBtn.disabled = true;
            selectedDate = null;
            els.dateInput.value = '';
          }
        }
      }
    }

    function validateTime() {
      if (!currentBarberAvailability || !selectedTime) return true;
      const start = currentBarberAvailability.startTime || '09:00';
      const end = currentBarberAvailability.endTime || '18:00';
      return selectedTime >= start && selectedTime <= end;
    }

    els.barberBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        els.barberBtns.forEach(b => b.classList.remove('ring-4'));
        btn.classList.add('ring-4');
        selectedBarber = btn.dataset.barberId;
        updateQueuePreview();
      });
    });

    els.dateInput?.addEventListener('change', (e) => { 
      selectedDate = e.target.value; 
      
      const allowedDates = getAllowedDates();
      if (!allowedDates.includes(selectedDate)) {
        els.queueInfo.textContent = 'Apenas hoje e amanh√£ s√£o permitidos.';
        els.joinQueueBtn.disabled = true;
        return;
      }
      
      if (currentBarberAvailability && currentBarberAvailability.days) {
        const dayOfWeek = new Date(selectedDate + 'T00:00:00').getDay().toString();
        if (!currentBarberAvailability.days.includes(dayOfWeek)) {
          els.queueInfo.textContent = 'Este barbeiro n√£o trabalha neste dia. Escolha outra data.';
          els.joinQueueBtn.disabled = true;
          return;
        }
      }
      updateQueuePreview(); 
    });
    
    els.timeInput?.addEventListener('change', (e) => { 
      selectedTime = e.target.value; 
      if (!validateTime()) {
        const start = currentBarberAvailability.startTime || '09:00';
        const end = currentBarberAvailability.endTime || '18:00';
        els.queueInfo.textContent = `Este barbeiro trabalha de ${start} √†s ${end}. Escolha outro hor√°rio.`;
        els.joinQueueBtn.disabled = true;
        return;
      }
      updateQueuePreview(); 
    });

    async function updateQueuePreview(){
      if (!selectedBarber || !selectedDate || !selectedTime){ 
        els.queueInfo.textContent = 'Escolha barbeiro, data e hor√°rio.'; 
        els.joinQueueBtn.disabled = true; 
        return; 
      }
      
      const allowedDates = getAllowedDates();
      if (!allowedDates.includes(selectedDate)) {
        els.queueInfo.textContent = 'Apenas hoje e amanh√£ s√£o permitidos.';
        els.joinQueueBtn.disabled = true;
        return;
      }
      
      if (currentBarberAvailability && currentBarberAvailability.days) {
        const dayOfWeek = new Date(selectedDate + 'T00:00:00').getDay().toString();
        if (!currentBarberAvailability.days.includes(dayOfWeek)) {
          els.queueInfo.textContent = 'Este barbeiro n√£o trabalha neste dia.';
          els.joinQueueBtn.disabled = true;
          return;
        }
      }
      
      if (!validateTime()) {
        const start = currentBarberAvailability.startTime || '09:00';
        const end = currentBarberAvailability.endTime || '18:00';
        els.queueInfo.textContent = `Hor√°rio inv√°lido. Trabalha de ${start} √†s ${end}.`;
        els.joinQueueBtn.disabled = true;
        return;
      }
      
      const qRef = query(collection(db, 'queues'), where('barberId','==', selectedBarber), where('date','==', selectedDate), where('time','==', selectedTime));
      const { getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
      const docs = await getDocs(qRef);
      const count = docs.size;
      els.queueInfo.textContent = count === 0 ? 'Sem fila. Voc√™ ser√° o primeiro.' : `Fila atual: ${count} pessoa(s). Sua posi√ß√£o ser√° ${count+1}.`;
      els.joinQueueBtn.disabled = false;
    }

    els.joinQueueBtn?.addEventListener('click', async () => {
      if (!currentUser || !selectedBarber || !selectedDate || !selectedTime) return;
      
      try {
        els.joinQueueBtn.disabled = true;
        els.joinQueueBtn.textContent = 'Entrando...';
        
        const entry = { userId: currentUser.uid, userName: currentUser.displayName || currentUser.email, barberId: selectedBarber, date: selectedDate, time: selectedTime, createdAt: new Date().toISOString() };
        const ref = await addDoc(collection(db, 'queues'), entry);
        
        // Armazena o ID do documento para poder remover depois
        currentQueueId = ref.id;
        
        // Abre automaticamente o modal com a posi√ß√£o na fila
        showRingModal(selectedBarber, selectedDate, selectedTime, ref.id);
      } catch(e) {
        console.error(e);
        alert('Erro ao entrar na fila. Tente novamente.');
      } finally {
        els.joinQueueBtn.disabled = false;
        els.joinQueueBtn.textContent = 'Entrar na fila';
      }
    });

    async function showRingModal(barberId, date, time, myId){
      const qRef = query(collection(db, 'queues'), where('barberId','==', barberId), where('date','==', date), where('time','==', time), orderBy('createdAt'));
      
      // Cancela listener anterior se existir
      if (queueListener) queueListener();
      
      queueListener = onSnapshot(qRef, (snap) => {
        const ids = [];
        snap.forEach(d => ids.push(d.id));
        const myPos = Math.max(1, ids.indexOf(myId) + 1);
        const ahead = Math.max(0, myPos - 1);
        els.ringNumber.textContent = ahead;
        els.ringModal.classList.add('show');
      });
    }

    els.leaveQueueBtn?.addEventListener('click', async () => {
      if (!currentQueueId) return;
      
      try {
        els.leaveQueueBtn.disabled = true;
        els.leaveQueueBtn.textContent = 'Saindo...';
        
        const { deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        await deleteDoc(doc(db, 'queues', currentQueueId));
        
        // Cancela o listener
        if (queueListener) {
          queueListener();
          queueListener = null;
        }
        
        // Fecha o modal e reseta o estado
        els.ringModal.classList.remove('show');
        currentQueueId = null;
        
        // Limpa sele√ß√µes e volta ao estado inicial
        selectedBarber = null;
        selectedDate = null;
        selectedTime = null;
        els.dateInput.value = '';
        els.timeInput.value = '';
        els.queueInfo.textContent = 'Escolha barbeiro, data e hor√°rio.';
        els.joinQueueBtn.disabled = true;
        
        document.querySelectorAll('.barber-btn').forEach(b => b.classList.remove('ring-4'));
      } catch(e) {
        console.error(e);
        alert('Erro ao sair da fila. Tente novamente.');
      } finally {
        els.leaveQueueBtn.disabled = false;
        els.leaveQueueBtn.textContent = 'Deixar a fila';
      }
    });

    els.otherDateBtn?.addEventListener('click', () => { els.ringModal.classList.remove('show'); });
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('Service Worker registrado:', reg.scope))
          .catch(err => console.error('Falha ao registrar SW:', err));
      });
    }
  </script>
</head>
<body>
  <div id="loading-screen" class="fixed inset-0 zele-primary flex items-center justify-center z-50">
    <div class="text-center text-white">
      <h1 class="text-4xl font-bold mb-2">Seu Vizinho</h1>
      <p class="opacity-80">Fila de Espera</p>
      <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-white mx-auto mt-6"></div>
    </div>
  </div>

  <div id="auth-screen" class="fixed inset-0 zele-primary flex items-center justify-center p-4 hidden">
    <div class="card rounded-2xl p-8 max-w-md w-full text-center">
      <img src="https://github.com/evomynd/fila-seu-vizinho-barbearia/blob/main/icons/icon-512x512.png?raw=true" alt="Seu Vizinho" class="w-24 h-24 mx-auto mb-4 rounded-full">
      <h1 class="text-3xl font-bold mb-2" style="color:#151b29">Seu Vizinho</h1>
      <p class="text-gray-600 mb-6">Fila de Espera</p>
      <button id="google-login-btn" class="w-full zele-btn font-bold py-3 px-6 rounded-lg mb-3">Entrar com Google</button>
      <button id="show-email-login" class="text-sm text-gray-600 hover:text-gray-800 underline">Entrar com email</button>
    </div>
  </div>

  <div id="email-login-modal" class="modal-overlay">
    <div class="card rounded-2xl p-6 max-w-md w-full mx-4">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold" style="color:#151b29">Autentica√ß√£o</h2>
        <button id="close-email-modal" class="text-gray-600">‚úï</button>
      </div>
      <p id="auth-error" class="text-sm text-red-600 mb-3"></p>
      
      <div id="email-login-form">
        <input id="login-email" type="email" placeholder="Email" class="w-full border border-gray-300 rounded-lg px-4 py-3 mb-3">
        <input id="login-password" type="password" placeholder="Senha" class="w-full border border-gray-300 rounded-lg px-4 py-3 mb-3">
        <button id="login-btn" class="w-full zele-btn font-bold py-3 px-6 rounded-lg mb-3">Entrar</button>
        <div class="text-center text-sm">
          <a href="#" id="show-signup" class="text-blue-600 hover:underline">Criar conta</a>
          <span class="mx-2 text-gray-400">‚Ä¢</span>
          <a href="#" id="show-reset" class="text-blue-600 hover:underline">Esqueci a senha</a>
        </div>
      </div>

      <div id="email-signup-form" class="hidden">
        <input id="signup-name" type="text" placeholder="Nome completo" class="w-full border border-gray-300 rounded-lg px-4 py-3 mb-3">
        <input id="signup-email" type="email" placeholder="Email" class="w-full border border-gray-300 rounded-lg px-4 py-3 mb-3">
        <input id="signup-password" type="password" placeholder="Senha (m√≠n. 6 caracteres)" class="w-full border border-gray-300 rounded-lg px-4 py-3 mb-3">
        <button id="signup-btn" class="w-full zele-btn font-bold py-3 px-6 rounded-lg mb-3">Criar Conta</button>
        <div class="text-center text-sm">
          <a href="#" id="show-login" class="text-blue-600 hover:underline">J√° tem conta? Entrar</a>
        </div>
      </div>

      <div id="email-reset-form" class="hidden">
        <p class="text-sm text-gray-600 mb-3">Digite seu email para receber o link de recupera√ß√£o de senha.</p>
        <input id="reset-email" type="email" placeholder="Email" class="w-full border border-gray-300 rounded-lg px-4 py-3 mb-3">
        <button id="reset-btn" class="w-full zele-btn font-bold py-3 px-6 rounded-lg mb-3">Enviar Link</button>
        <div class="text-center text-sm">
          <a href="#" id="show-login" class="text-blue-600 hover:underline">Voltar ao login</a>
        </div>
      </div>
    </div>
  </div>

  <div id="app-container" class="hidden">
    <header class="zele-primary text-white">
      <div class="container mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <h1 class="text-2xl font-bold">Seu Vizinho</h1>
        </div>
        <div class="flex items-center gap-4">
          <div class="text-right hidden sm:block">
            <p id="user-name" class="text-sm font-semibold">Usu√°rio</p>
            <p id="user-email" class="text-xs opacity-90">email@example.com</p>
          </div>
          <img id="user-photo" src="" alt="Foto" class="w-10 h-10 rounded-full border-2 border-white">
          <button id="menu-btn" class="zele-btn p-2 rounded-lg">‚ò∞</button>
        </div>
      </div>
    </header>

    <div id="menu-overlay" class="modal-overlay"></div>
    <div id="menu-drawer" class="fixed top-0 right-[-300px] w-[300px] h-full bg-white shadow-xl z-[9999] transition-all">
      <div class="p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold" style="color:#151b29">Menu</h2>
          <button id="menu-close-btn" class="text-gray-600">‚úï</button>
        </div>
        <div class="space-y-2">
          <button id="menu-admin-btn" class="w-full p-3 border rounded-lg text-left hover:bg-gray-50">‚öôÔ∏è Administra√ß√£o</button>
        </div>
      </div>
    </div>

    <main class="container mx-auto px-4 py-8 max-w-3xl">
      <div class="card rounded-xl p-6 mb-6">
        <h2 class="text-2xl font-bold mb-4" style="color:#151b29">Escolha o barbeiro</h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <p class="col-span-3 text-center text-gray-600">Carregando barbeiros...</p>
        </div>
      </div>

      <div class="card rounded-xl p-6 mb-6">
        <h2 class="text-2xl font-bold mb-4" style="color:#151b29">Data e Hor√°rio</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-semibold mb-1" style="color:#151b29">Data</label>
            <input id="date-input" type="date" class="w-full border border-gray-300 rounded-lg px-4 py-3">
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1" style="color:#151b29">Hor√°rio</label>
            <input id="time-input" type="time" class="w-full border border-gray-300 rounded-lg px-4 py-3">
          </div>
        </div>
        <p id="queue-info" class="text-sm text-gray-600 mt-3">Escolha barbeiro, data e hor√°rio.</p>
        <div class="flex gap-3 mt-4">
          <button id="join-queue-btn" class="flex-1 zele-btn font-bold py-3 px-6 rounded-lg" disabled>Entrar na fila</button>
          <button id="other-date-btn" class="flex-1 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg">Ver outra data</button>
        </div>
      </div>
    </main>
  </div>

  <div id="ring-modal" class="modal-overlay">
    <div class="card rounded-2xl p-6 max-w-sm w-full mx-4 text-center">
      <h3 class="text-xl font-bold mb-4" style="color:#151b29">Sua posi√ß√£o</h3>
      <div class="mx-auto w-40 h-40 rounded-full border-[10px] border-blue-600 flex items-center justify-center">
        <span id="ring-number" class="text-5xl font-bold">0</span>
      </div>
      <p class="text-sm text-gray-600 mt-4">N√∫mero de pessoas √† sua frente</p>
      <div class="flex gap-3 mt-6">
        <button id="leave-queue-btn" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">Deixar a fila</button>
        <button class="flex-1 zele-btn font-bold py-3 px-6 rounded-lg" onclick="document.getElementById('ring-modal').classList.remove('show')">Fechar</button>
      </div>
    </div>
  </div>

    <!-- Modal fila admin -->
    <div id="admin-queue-modal" class="modal-overlay">
      <div class="card rounded-2xl p-6 max-w-md w-full mx-4">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold" style="color:#151b29">Fila de clientes</h2>
          <button id="close-admin-queue-modal" class="text-gray-600">‚úï</button>
        </div>
        <div id="admin-queue-list" class="space-y-2"></div>
      </div>
    </div>

  <div id="availability-modal" class="modal-overlay">
    <div class="card rounded-2xl p-6 max-w-md w-full mx-4">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold" style="color:#151b29">Disponibilidade</h2>
        <button id="close-availability-modal" class="text-gray-600">‚úï</button>
      </div>
      <p id="avail-barber-name" class="text-sm text-gray-600 mb-4 font-semibold"></p>
      
      <div class="mb-4">
        <label class="block text-sm font-semibold mb-2" style="color:#151b29">Dias da semana</label>
        <div class="grid grid-cols-2 gap-2">
          <label class="flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-gray-50">
            <input type="checkbox" value="0" class="day-checkbox">
            <span>Domingo</span>
          </label>
          <label class="flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-gray-50">
            <input type="checkbox" value="1" class="day-checkbox">
            <span>Segunda</span>
          </label>
          <label class="flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-gray-50">
            <input type="checkbox" value="2" class="day-checkbox">
            <span>Ter√ßa</span>
          </label>
          <label class="flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-gray-50">
            <input type="checkbox" value="3" class="day-checkbox">
            <span>Quarta</span>
          </label>
          <label class="flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-gray-50">
            <input type="checkbox" value="4" class="day-checkbox">
            <span>Quinta</span>
          </label>
          <label class="flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-gray-50">
            <input type="checkbox" value="5" class="day-checkbox">
            <span>Sexta</span>
          </label>
          <label class="flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-gray-50">
            <input type="checkbox" value="6" class="day-checkbox">
            <span>S√°bado</span>
          </label>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3 mb-4">
        <div>
          <label class="block text-sm font-semibold mb-1" style="color:#151b29">In√≠cio</label>
          <input id="avail-start-time" type="time" value="09:00" class="w-full border border-gray-300 rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1" style="color:#151b29">Fim</label>
          <input id="avail-end-time" type="time" value="18:00" class="w-full border border-gray-300 rounded-lg px-3 py-2">
        </div>
      </div>

      <button id="save-availability-btn" class="w-full zele-btn font-bold py-3 px-6 rounded-lg">Salvar</button>
    </div>
  </div>

  <div id="admin-page" class="hidden">
    <header class="zele-primary text-white">
      <div class="container mx-auto px-4 py-4 flex items-center gap-3">
        <button id="back-from-admin" class="zele-btn p-2 rounded-lg">‚Üê</button>
        <h1 class="text-2xl font-bold">Admin: Barbeiros</h1>
      </div>
    </header>
    <main class="container mx-auto px-4 py-8 max-w-3xl">
      <div class="card rounded-xl p-6">
        <h2 class="text-xl font-bold mb-4" style="color:#151b29">Gerenciar Barbeiros</h2>
        <div class="flex gap-2 mb-4">
          <input id="admin-barber-name" type="text" class="flex-1 border border-gray-300 rounded-lg px-3 py-2" placeholder="Nome do barbeiro">
          <button id="admin-add-barber-btn" class="zele-btn px-4 py-2 rounded-lg font-semibold">Adicionar</button>
        </div>
        <div id="admin-barber-list" class="space-y-2"></div>
      </div>
    </main>
  </div>
</body>
</html>
