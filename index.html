<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>BarberQueue - Multi Barbeiros</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Sistema de gerenciamento de fila para barbearias - BarberQueue">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BarberQueue">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        @keyframes spin { to { transform: rotate(360deg); } }

        .status-waiting { border-left: 4px solid #f59e0b; }
        .status-cutting { border-left: 4px solid #10b981; border: 2px solid #10b981; background-color: rgba(16, 185, 129, 0.1); }
        .status-mine { border: 2px solid #f59e0b; background-color: rgba(245, 158, 11, 0.1); } /* Destaque do cliente */
        
        /* Toggle Switch CSS */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #10b981;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #10b981;
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700 p-4 shadow-lg flex justify-between items-center z-10">
        <div class="flex items-center gap-3 cursor-pointer" onclick="goHome()">
            <i class="fa-solid fa-scissors text-amber-500 text-2xl"></i>
            <h1 class="text-xl font-bold tracking-tight">Barber<span class="text-amber-500">Queue</span></h1>
        </div>
        <div class="flex gap-2 items-center">
            <span id="headerContext" class="text-xs font-bold text-slate-400 uppercase tracking-widest hidden md:block"></span>
            
            <!-- Botão Instalar App -->
            <button onclick="installPWA()" id="installBtn" class="hidden bg-green-600 hover:bg-green-500 text-xs px-3 py-2 rounded-lg transition border border-green-400">
                <i class="fa-solid fa-download mr-1"></i> <span class="hidden md:inline">Instalar App</span>
            </button>
            
            <button onclick="openLoginModal()" id="adminBtn" class="bg-slate-700 hover:bg-slate-600 text-xs px-3 py-2 rounded-lg transition border border-slate-600">
                <i class="fa-solid fa-lock mr-1"></i> Área Restrita
            </button>
            <button onclick="logout()" id="logoutBtn" class="hidden bg-red-600 hover:bg-red-500 text-xs px-3 py-2 rounded-lg transition border border-red-400">
                <i class="fa-solid fa-right-from-bracket mr-1"></i> <span id="logoutText">Sair</span>
            </button>
            <button onclick="logout()" id="clientLogoutBtn" class="bg-slate-700 hover:bg-slate-600 text-xs px-3 py-2 rounded-lg transition border border-slate-600">
                <i class="fa-solid fa-user-circle mr-1"></i> <span id="userEmail" class="hidden md:inline">Conta</span>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 relative overflow-hidden flex flex-col">

        <!-- LOADING SCREEN (Aparece durante login/carregamento) -->
        <div id="loadingScreen" class="absolute inset-0 z-50 bg-slate-900 flex items-center justify-center hidden">
            <div class="text-center">
                <div class="mb-6">
                    <i class="fa-solid fa-scissors text-amber-500 text-5xl mb-4 fa-spin" style="animation: spin 2s linear infinite;"></i>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Carregando BarberQueue</h2>
                <p class="text-slate-400 text-sm">Aguarde um momento...</p>
            </div>
        </div>

        <!-- INITIAL LOGIN SCREEN (Must login before using app) -->
        <div id="initialLoginScreen" class="absolute inset-0 z-50 bg-slate-900 flex items-center justify-center p-6">
            <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-md text-center">
                <div class="mb-6">
                    <i class="fa-solid fa-scissors text-amber-500 text-5xl mb-4"></i>
                    <h1 class="text-3xl font-bold text-white mb-2">Bem-vindo ao <span class="text-amber-500">BarberQueue</span></h1>
                    <p class="text-slate-400 text-sm">Entre com sua conta para continuar</p>
                </div>
                
                <!-- Login com Google -->
                <button onclick="clientLoginWithGoogle()" id="googleLoginBtn" class="w-full bg-white hover:bg-gray-100 text-gray-800 font-bold py-3 rounded-lg mb-3 flex items-center justify-center gap-3 transition">
                    <i class="fa-brands fa-google text-xl"></i>
                    Continuar com Google
                </button>
                
                <!-- Divisor -->
                <div class="flex items-center gap-3 my-4">
                    <div class="flex-1 h-px bg-slate-600"></div>
                    <span class="text-slate-500 text-xs">OU</span>
                    <div class="flex-1 h-px bg-slate-600"></div>
                </div>
                
                <!-- Login com Email -->
                <div class="mb-4 space-y-3">
                    <input type="email" id="clientEmailInput" placeholder="Seu email" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-amber-500 focus:outline-none">
                    <input type="password" id="clientPasswordInput" placeholder="Sua senha" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-amber-500 focus:outline-none">
                    <div class="flex gap-2">
                        <button onclick="clientLoginWithEmail()" id="emailLoginBtn" class="flex-1 py-3 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-500">Entrar</button>
                        <button onclick="clientRegisterWithEmail()" id="registerBtn" class="flex-1 py-3 rounded-lg bg-emerald-600 text-white font-bold hover:bg-emerald-500">Cadastrar</button>
                    </div>
                </div>
                
                <p class="text-slate-500 text-xs mt-6">Ao continuar, você concorda com nossos termos de uso</p>
            </div>
        </div>

        <!-- VIEW 1: SELECTION SCREEN (Home) -->
        <div id="viewSelection" class="absolute inset-0 z-30 bg-slate-900 flex flex-col items-center p-6 py-12 fade-in overflow-y-auto">
            <h2 class="text-3xl font-bold text-white mb-2 text-center">Escolha seu Profissional</h2>
            <p class="text-slate-400 mb-8 text-center">Selecione quem vai te atender hoje.</p>
            
            <div id="barberGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 w-full max-w-4xl pb-8">
                <div class="col-span-full text-center text-slate-500">Carregando barbeiros...</div>
            </div>
            
            <!-- Aviso se o usuário já estiver em uma fila -->
            <div id="homeActiveTicketNotice" class="hidden mt-8 p-4 bg-amber-500/10 border border-amber-500/50 rounded-xl flex items-center gap-3 max-w-md w-full animate-pulse cursor-pointer hover:bg-amber-500/20 transition" onclick="returnToMyQueue()">
                <div class="bg-amber-500 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold">
                    <i class="fa-solid fa-ticket"></i>
                </div>
                <div class="text-left flex-1">
                    <p class="text-sm text-slate-300">Você já está na fila de <strong id="homeTicketBarberName" class="text-white">--</strong></p>
                    <p class="text-xs text-amber-500 font-bold">Clique para ver sua posição</p>
                </div>
                <i class="fa-solid fa-chevron-right text-slate-500"></i>
            </div>
        </div>

        <!-- VIEW 2: QUEUE INTERFACE (Split Screen) -->
        <div id="viewQueue" class="flex-1 flex flex-col md:flex-row h-full hidden overflow-hidden">
            
            <!-- Left: Add to Queue (Customer) -->
            <section id="customerPanel" class="w-full md:w-1/3 bg-slate-800/50 p-6 flex flex-col justify-center items-center border-r border-slate-700 relative z-20 transition-all duration-300 overflow-y-auto md:overflow-y-visible">
                <button onclick="goHome()" class="absolute top-4 left-4 text-slate-500 hover:text-white flex items-center gap-2 text-sm">
                    <i class="fa-solid fa-arrow-left"></i> Voltar
                </button>

                <div class="max-w-sm w-full space-y-6 mt-8 md:mt-0">
                    <div class="text-center">
                        <div class="mb-2 inline-block p-3 rounded-full bg-slate-800 border border-slate-600">
                            <i class="fa-solid fa-user-tag text-amber-500 text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-white mb-1">Entrar na Fila</h2>
                        <p class="text-slate-400 text-sm">Fila de: <strong id="queueBarberName" class="text-white">--</strong></p>
                    </div>

                    <!-- STATE 1: FORM (Visible only if NOT in queue) -->
                    <div id="joinFormContainer" class="space-y-4">
                        <div>
                            <label class="block text-xs font-semibold text-slate-400 mb-1 uppercase tracking-wider">Seu Nome</label>
                            <input type="text" id="clientName" placeholder="Ex: João Silva" 
                                class="w-full bg-slate-900 border border-slate-700 text-white text-lg px-4 py-3 rounded-xl focus:outline-none focus:border-amber-500 focus:ring-1 focus:ring-amber-500 transition shadow-inner">
                        </div>
                        <button onclick="addToQueue()" id="joinBtn" 
                            class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-400 hover:to-orange-500 text-white font-bold py-4 rounded-xl shadow-lg transform active:scale-95 transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-ticket"></i> Pegar Senha
                        </button>
                    </div>
                    
                    <!-- STATE 2: ACTIVE TICKET (Visible only if IN queue) -->
                    <div id="activeTicketDisplay" class="hidden w-full bg-amber-500/10 border border-amber-500/30 rounded-xl p-6 text-center">
                        <div class="text-amber-500 text-4xl mb-2"><i class="fa-solid fa-ticket-alt"></i></div>
                        <h3 class="text-white font-bold text-lg mb-1">Você está na fila!</h3>
                        <p class="text-slate-400 text-sm mb-4">Acompanhe sua posição no painel ao lado.</p>
                        
                        <div class="bg-slate-900/50 rounded-lg p-3 mb-4">
                            <p class="text-xs text-slate-500 uppercase">Sua Posição</p>
                            <p class="text-2xl font-bold text-white" id="myPositionDisplay">--</p>
                        </div>
                        
                        <button onclick="confirmExitQueue()" class="text-red-400 hover:text-red-300 text-sm underline">
                            Cancelar minha vez e sair
                        </button>
                    </div>

                    <!-- STATE 3: NO SHOW WARNING -->
                    <div id="noShowNotice" class="hidden w-full bg-red-500/10 border border-red-500/30 rounded-xl p-6 text-center">
                        <div class="text-red-500 text-4xl mb-2"><i class="fa-solid fa-exclamation-triangle"></i></div>
                        <h3 class="text-white font-bold text-lg mb-1">Você perdeu sua vez!</h3>
                        <p class="text-red-400 text-sm mb-4 font-bold">VOCÊ NÃO ESTAVA NO SALÃO</p>
                        <p class="text-slate-400 text-xs mb-4">Você pode entrar na fila novamente se desejar.</p>
                        
                        <button onclick="clearNoShowAndRejoin()" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-400 hover:to-orange-500 text-white font-bold py-3 rounded-xl shadow-lg transition">
                            Entrar na Fila Novamente
                        </button>
                    </div>

                    <div id="joinMessage" class="hidden text-center p-3 rounded-lg bg-emerald-500/20 text-emerald-400 text-sm font-medium fade-in">
                        <i class="fa-solid fa-check-circle mr-1"></i> Você entrou na fila!
                    </div>
                </div>

                <!-- Stats Mobile -->
                <div class="mt-8 grid grid-cols-2 gap-4 w-full max-w-sm md:hidden">
                    <div class="bg-slate-700/50 p-3 rounded-lg text-center">
                        <div class="text-2xl font-bold text-white" id="statWaitingMobile">0</div>
                        <div class="text-xs text-slate-400">Na espera</div>
                    </div>
                    <div class="bg-slate-700/50 p-3 rounded-lg text-center">
                        <div class="text-2xl font-bold text-emerald-400" id="statAvgMobile">--</div>
                        <div class="text-xs text-slate-400">Tempo Médio</div>
                    </div>
                </div>
            </section>

            <!-- Right: Queue Display (TV/Barber) -->
            <section class="flex-1 bg-slate-900 p-4 md:p-8 flex flex-col h-full overflow-hidden md:overflow-visible">
                <div class="mb-6 flex justify-between items-end border-b border-slate-800 pb-4">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-bold text-white">Fila de <span id="displayBarberName" class="text-amber-500">--</span></h2>
                        <p class="text-slate-400 text-sm mt-1">Atualizado em tempo real</p>
                    </div>
                    <div class="hidden md:flex gap-6 text-right">
                        <div>
                            <span class="block text-3xl font-bold text-white" id="statWaiting">0</span>
                            <span class="text-xs text-slate-500 uppercase font-bold">Pessoas</span>
                        </div>
                        <div>
                            <span class="block text-3xl font-bold text-emerald-400"><span id="statAvgDesktop">0</span><span class="text-sm text-emerald-600 ml-1">min</span></span>
                            <span class="text-xs text-slate-500 uppercase font-bold">Estimado</span>
                        </div>
                    </div>
                </div>

                <!-- Active Cut -->
                <div id="activeCutContainer" class="hidden mb-6 fade-in">
                    <div id="activeCutContent" class="bg-gradient-to-r from-emerald-900/40 to-slate-800 border border-emerald-500/30 rounded-2xl p-6 flex items-center justify-between shadow-lg relative overflow-hidden">
                        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-emerald-500 blur-3xl opacity-20 rounded-full"></div>
                        <div class="flex items-center gap-6 relative z-10">
                            <div class="bg-emerald-500/20 p-4 rounded-full text-emerald-400 animate-pulse">
                                <i class="fa-solid fa-chair text-3xl"></i>
                            </div>
                            <div>
                                <p class="text-emerald-400 font-bold text-sm uppercase tracking-widest mb-1">Cortando Agora</p>
                                <h3 class="text-3xl md:text-4xl font-bold text-white" id="activeClientName">Cliente</h3>
                            </div>
                        </div>
                        
                        <div class="barber-controls hidden flex gap-3">
                            <button onclick="openPauseModal()" class="bg-amber-600 hover:bg-amber-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition flex flex-col items-center">
                                <i class="fa-solid fa-pause text-xl mb-1"></i>
                                <span class="text-xs">Pausar</span>
                            </button>
                            <button onclick="finishCut()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition flex flex-col items-center">
                                <i class="fa-solid fa-check text-xl mb-1"></i>
                                <span class="text-xs">Finalizar</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Queue List -->
                <div class="flex-1 overflow-y-auto pr-2" id="queueList">
                    <div class="flex flex-col items-center justify-center h-64 text-slate-600">
                        <i class="fa-solid fa-spinner fa-spin text-4xl mb-4 opacity-50"></i>
                        <p>Carregando...</p>
                    </div>
                </div>
            </section>
        </div>

        <!-- VIEW 3: ADMIN PANEL -->
        <div id="viewAdmin" class="absolute inset-0 z-40 bg-slate-900 p-6 md:p-12 overflow-y-auto hidden flex flex-col">
            <div class="max-w-7xl mx-auto w-full pb-12">
                <div class="flex justify-between items-center mb-8 border-b border-slate-700 pb-4">
                    <h2 class="text-3xl font-bold text-white"><i class="fa-solid fa-users-gear mr-2 text-amber-500"></i>Gestão de Barbeiros</h2>
                    <button onclick="logout()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-times text-xl"></i> Fechar</button>
                </div>

                <!-- Tabs Navigation -->
                <div class="flex gap-4 mb-8 border-b border-slate-700 pb-4">
                    <button onclick="switchAdminTab('gestao')" id="tab-gestao" class="px-4 py-2 font-bold text-white bg-amber-600 rounded-t-lg tab-btn">
                        <i class="fa-solid fa-users-gear mr-2"></i> Gestão
                    </button>
                    <button onclick="switchAdminTab('dashboard')" id="tab-dashboard" class="px-4 py-2 font-bold text-slate-400 hover:text-white rounded-t-lg tab-btn">
                        <i class="fa-solid fa-chart-line mr-2"></i> Dashboard
                    </button>
                </div>

                <!-- TAB 1: Gestão de Barbeiros -->
                <div id="tab-content-gestao" class="tab-content">
                    <!-- Add New Barber -->
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 mb-8">
                        <h3 class="text-lg font-bold text-white mb-4">Adicionar Novo Profissional</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="text" id="newBarberName" placeholder="Nome (Ex: Carlos)" class="bg-slate-900 border border-slate-600 rounded-lg p-3 text-white">
                            <input type="text" id="newBarberPin" placeholder="PIN de Acesso (Ex: 1234)" class="bg-slate-900 border border-slate-600 rounded-lg p-3 text-white">
                            <button onclick="addBarber()" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg p-3">
                                <i class="fa-solid fa-plus mr-1"></i> Adicionar
                            </button>
                        </div>
                    </div>

                    <!-- List Barbers -->
                    <h3 class="text-lg font-bold text-white mb-4">Equipe Cadastrada</h3>
                    <div id="adminBarberList" class="space-y-3">
                        <!-- Injected via JS -->
                    </div>
                </div>

                <!-- TAB 2: Dashboard de Estatísticas -->
                <div id="tab-content-dashboard" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <!-- Gráfico 1: Cortes Concluídos -->
                        <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg">
                            <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-check-circle text-emerald-400"></i>
                                Cortes Concluídos
                            </h3>
                            <canvas id="chartCompletedCuts"></canvas>
                        </div>

                        <!-- Gráfico 2: Faltas -->
                        <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg">
                            <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-calendar-xmark text-red-400"></i>
                                Faltas por Barbeiro
                            </h3>
                            <canvas id="chartNoShows"></canvas>
                        </div>

                        <!-- Gráfico 3: Tempo Médio -->
                        <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg">
                            <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-hourglass-end text-blue-400"></i>
                                Tempo Médio (min)
                            </h3>
                            <canvas id="chartAvgTime"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- CONFIRMATION MODAL 1: CHANGE BARBER -->
    <div id="modalConfirmChange" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 fade-in">
        <div class="bg-slate-800 p-6 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-sm text-center">
            <i class="fa-solid fa-triangle-exclamation text-amber-500 text-4xl mb-4"></i>
            <h3 class="text-xl font-bold text-white mb-2">Sair da Fila Atual?</h3>
            <p class="text-slate-300 text-sm mb-6">Você já está na fila de <strong id="currentBarberNameModal" class="text-white">--</strong>. Se mudar de barbeiro, você perderá sua vez.</p>
            <div class="flex gap-3">
                <button onclick="closeModal('modalConfirmChange')" class="flex-1 py-3 rounded-lg bg-slate-700 text-white hover:bg-slate-600 font-medium">Manter minha vez</button>
                <button onclick="openFinalWarning()" class="flex-1 py-3 rounded-lg bg-red-600 text-white font-bold hover:bg-red-500">Sair da fila</button>
            </div>
        </div>
    </div>

    <!-- CONFIRMATION MODAL 2: FINAL WARNING -->
    <div id="modalFinalWarning" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden items-center justify-center z-[60] fade-in">
        <div class="bg-slate-800 p-6 rounded-2xl shadow-2xl border-2 border-red-500/50 w-full max-w-sm text-center">
            <i class="fa-solid fa-ban text-red-500 text-4xl mb-4"></i>
            <h3 class="text-xl font-bold text-white mb-2">Último Aviso!</h3>
            <p class="text-slate-300 text-sm mb-6">Se você sair agora e quiser voltar depois, será o <strong>último da fila</strong>. Tem certeza?</p>
            <div class="flex gap-3">
                <button onclick="closeModal('modalFinalWarning')" class="flex-1 py-3 rounded-lg bg-slate-700 text-white hover:bg-slate-600 font-medium">Não, quero ficar</button>
                <button onclick="confirmSwitchBarber()" class="flex-1 py-3 rounded-lg bg-red-600 text-white font-bold hover:bg-red-500">Sim, sair da fila</button>
            </div>
        </div>
    </div>

    <!-- PAUSE MODAL (Barber) -->
    <div id="pauseModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 fade-in">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-sm">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <i class="fa-solid fa-pause text-amber-500"></i>
                Pausar Atendimento
            </h3>
            <p class="text-slate-400 text-sm mb-6">Selecione o motivo da pausa:</p>
            <div class="space-y-3 mb-6">
                <button onclick="setPauseReason('almoco')" class="w-full text-left bg-slate-700 hover:bg-slate-600 text-white px-4 py-3 rounded-lg transition border border-slate-600">
                    <i class="fa-solid fa-utensils mr-2 text-amber-500"></i> Almoço
                </button>
                <button onclick="setPauseReason('lanche')" class="w-full text-left bg-slate-700 hover:bg-slate-600 text-white px-4 py-3 rounded-lg transition border border-slate-600">
                    <i class="fa-solid fa-coffee mr-2 text-amber-500"></i> Lanche
                </button>
                <button onclick="setPauseReason('banheiro')" class="w-full text-left bg-slate-700 hover:bg-slate-600 text-white px-4 py-3 rounded-lg transition border border-slate-600">
                    <i class="fa-solid fa-restroom mr-2 text-amber-500"></i> Banheiro
                </button>
                <button onclick="setPauseReason('saida')" class="w-full text-left bg-slate-700 hover:bg-slate-600 text-white px-4 py-3 rounded-lg transition border border-slate-600">
                    <i class="fa-solid fa-door-open mr-2 text-amber-500"></i> Saída do Salão
                </button>
                <button onclick="setPauseReason('outros')" class="w-full text-left bg-slate-700 hover:bg-slate-600 text-white px-4 py-3 rounded-lg transition border border-slate-600">
                    <i class="fa-solid fa-ellipsis mr-2 text-amber-500"></i> Outros
                </button>
            </div>
            <button onclick="closePauseModal()" class="w-full py-3 rounded-lg bg-slate-700 text-white hover:bg-slate-600 font-medium">Cancelar</button>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 fade-in">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-md text-center">
            <i class="fa-solid fa-lock text-amber-500 text-3xl mb-4"></i>
            <h3 class="text-xl font-bold text-white mb-2">Acesso Restrito</h3>
            <p class="text-slate-400 text-sm mb-6" id="modalSubtitle">Barbeiros e Administradores</p>
            
            <!-- Seção de Autenticação (esconde quando usuário já está autenticado) -->
            <div id="authSection">
                <!-- Aviso de Autenticação -->
                <div id="barberAuthWarning" class="bg-amber-900/30 border border-amber-600 rounded-lg p-3 mb-4 text-xs text-amber-200 hidden">
                    <i class="fa-solid fa-exclamation-triangle mr-1"></i>
                    <strong>Atenção:</strong> Você precisa estar autenticado no Firebase. Faça login com email/Google primeiro.
                </div>
                
                <!-- Login com Google -->
                <button onclick="loginWithGoogle()" class="w-full bg-white hover:bg-gray-100 text-gray-800 font-bold py-3 rounded-lg mb-3 flex items-center justify-center gap-3 transition">
                    <i class="fa-brands fa-google text-xl"></i>
                    Continuar com Google
                </button>
                
                <!-- Divisor -->
                <div class="flex items-center gap-3 my-4">
                    <div class="flex-1 h-px bg-slate-600"></div>
                    <span class="text-slate-500 text-xs">OU</span>
                    <div class="flex-1 h-px bg-slate-600"></div>
                </div>
                
                <!-- Login com Email -->
                <div id="emailLoginForm" class="mb-4 space-y-3">
                    <input type="email" id="emailInput" placeholder="Seu email" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-amber-500 focus:outline-none">
                    <input type="password" id="passwordInput" placeholder="Sua senha" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-amber-500 focus:outline-none">
                    <div class="flex gap-2">
                        <button onclick="loginWithEmail()" class="flex-1 py-3 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-500">Entrar</button>
                        <button onclick="registerWithEmail()" class="flex-1 py-3 rounded-lg bg-emerald-600 text-white font-bold hover:bg-emerald-500">Cadastrar</button>
                    </div>
                </div>
                
                <!-- Divisor -->
                <div class="flex items-center gap-3 my-4">
                    <div class="flex-1 h-px bg-slate-600"></div>
                    <span class="text-slate-500 text-xs">BARBEIROS</span>
                    <div class="flex-1 h-px bg-slate-600"></div>
                </div>
            </div>
            
            <!-- Seção do PIN (sempre visível) -->
            <div id="pinSection">
                <!-- Indicador de usuário autenticado -->
                <div id="authenticatedIndicator" class="hidden bg-emerald-900/30 border border-emerald-600 rounded-lg p-3 mb-4 text-xs text-emerald-200">
                    <i class="fa-solid fa-check-circle mr-1"></i>
                    <strong>Autenticado:</strong> <span id="authUserEmail"></span>
                </div>
                
                <p class="text-slate-400 text-xs mb-2">Acesso de Barbeiro/Admin (PIN)</p>
                <input type="password" id="pinInput" placeholder="Digite o PIN" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white text-center text-2xl tracking-widest mb-4 focus:border-amber-500 focus:outline-none">
                <button onclick="processLogin()" class="w-full py-3 rounded-lg bg-amber-600 text-white font-bold hover:bg-amber-500 mb-3">Entrar com PIN</button>
            </div>
            
            <button onclick="closeLoginModal()" class="w-full py-3 rounded-lg bg-slate-700 text-slate-300 hover:bg-slate-600">Voltar</button>
        </div>
    </div>

    <!-- No-Show Alert Modal -->
    <div id="noShowModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden items-center justify-center z-50 fade-in">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl border-2 border-red-500 w-full max-w-md text-center animate-pulse">
            <div class="text-red-500 text-6xl mb-4">
                <i class="fa-solid fa-triangle-exclamation"></i>
            </div>
            <h3 class="text-2xl font-bold text-white mb-3">Você foi Removido da Fila</h3>
            <p class="text-red-400 text-lg font-bold mb-2">VOCÊ NÃO ESTAVA NO SALÃO</p>
            <p class="text-slate-300 text-sm mb-6">
                O barbeiro chamou você, mas você não estava presente no estabelecimento.
                Por isso, você foi retirado da fila.
            </p>
            <p class="text-slate-400 text-xs mb-6">
                Você pode entrar na fila novamente quando estiver no salão.
            </p>
            <button onclick="closeNoShowModal()" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-400 hover:to-orange-500 text-white font-bold py-4 rounded-xl shadow-lg transition-all transform hover:scale-105">
                <i class="fa-solid fa-check-circle mr-2"></i> OK, Entendi
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
        
        const userFirebaseConfig = {
            apiKey: "AIzaSyCyTJVlgvkLa2-SUNaxAlOiTezcXfjiP64",
            authDomain: "seu-vizinho-barbearia.firebaseapp.com",
            projectId: "seu-vizinho-barbearia",
            storageBucket: "seu-vizinho-barbearia.firebasestorage.app",
            messagingSenderId: "25346983688",
            appId: "1:25346983688:web:727308786e34874ae50ebd"
        };

        let firebaseConfig;
        let useInternalPath = false;

        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            useInternalPath = true;
        } else {
            firebaseConfig = userFirebaseConfig;
            useInternalPath = false;
        }
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Constants
        const QUEUE_COL = 'queue';
        const BARBERS_COL = 'barbers';
        const MASTER_PIN = "9999";

        // State
        let currentUser = null;
        let queueData = [];
        let barbersData = [];
        let selectedBarber = null; 
        let loggedInMode = null; 
        let loggedInBarberId = null; 
        let myTicket = null; // Stores { id, barberId, name } if user is in queue
        let pendingBarberSwitch = null; // Stores target barber ID during confirmation
        
        // Listener unsubscribe functions
        let unsubscribeBarbersListener = null;
        let unsubscribeQueueListener = null;

        // --- CLIENT LOGIN FUNCTIONS (Must be global for onclick handlers) ---
        window.clientLoginWithGoogle = async () => {
            // Mostrar loading
            document.getElementById('loadingScreen').classList.remove('hidden');
            document.getElementById('initialLoginScreen').classList.add('hidden');
            
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                // onAuthStateChanged vai lidar com a navegação
            } catch (error) {
                // Esconder loading e mostrar tela de login novamente
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('initialLoginScreen').classList.remove('hidden');
                
                console.error('Erro no login com Google:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    alert('Login cancelado.');
                } else if (error.code === 'auth/operation-not-allowed') {
                    alert('⚠️ Login com Google não está ativado no Firebase.\n\nVá em Authentication > Sign-in method > Google e ative.');
                } else {
                    alert('Erro ao fazer login com Google: ' + error.message);
                }
            }
        };
        
        window.clientLoginWithEmail = async () => {
            const email = document.getElementById('clientEmailInput').value.trim();
            const password = document.getElementById('clientPasswordInput').value;
            
            if (!email || !password) {
                alert('Preencha email e senha');
                return;
            }
            
            // Mostrar loading
            document.getElementById('loadingScreen').classList.remove('hidden');
            document.getElementById('initialLoginScreen').classList.add('hidden');
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged vai lidar com a navegação
            } catch (error) {
                // Esconder loading e mostrar tela de login novamente
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('initialLoginScreen').classList.remove('hidden');
                
                console.error('Erro no login:', error);
                if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                    alert('Email ou senha incorretos.');
                } else if (error.code === 'auth/invalid-email') {
                    alert('Email inválido.');
                } else {
                    alert('Erro ao fazer login: ' + error.message);
                }
            }
        };
        
        window.clientRegisterWithEmail = async () => {
            const email = document.getElementById('clientEmailInput').value.trim();
            const password = document.getElementById('clientPasswordInput').value;
            
            if (!email || !password) {
                alert('Preencha email e senha');
                return;
            }
            
            if (password.length < 6) {
                alert('A senha deve ter pelo menos 6 caracteres.');
                return;
            }
            
            // Show loading screen
            document.getElementById('loadingScreen').classList.remove('hidden');
            document.getElementById('initialLoginScreen').classList.add('hidden');
            
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // onAuthStateChanged vai lidar com a navegação
            } catch (error) {
                console.error('Erro no cadastro:', error);
                // Hide loading and show login again on error
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('initialLoginScreen').classList.remove('hidden');
                
                if (error.code === 'auth/email-already-in-use') {
                    alert('Este email já está cadastrado. Tente fazer login.');
                } else if (error.code === 'auth/invalid-email') {
                    alert('Email inválido.');
                } else if (error.code === 'auth/weak-password') {
                    alert('Senha muito fraca. Use pelo menos 6 caracteres.');
                } else {
                    alert('Erro ao cadastrar: ' + error.message);
                }
            }
        };

        // Helper Functions for Paths
        function getCollection(colName) {
            if (useInternalPath) return collection(db, 'artifacts', appId, 'public', 'data', colName);
            return collection(db, colName);
        }
        function getDocRef(colName, docId) {
            if (useInternalPath) return doc(db, 'artifacts', appId, 'public', 'data', colName, docId);
            return doc(db, colName, docId);
        }

        // Format elapsed time to show hours and minutes
        function formatElapsedTime(joinedAtTimestamp) {
            const now = Date.now();
            const elapsedMs = now - joinedAtTimestamp;
            const elapsedMinutes = Math.floor(elapsedMs / 60000);
            const hours = Math.floor(elapsedMinutes / 60);
            const minutes = elapsedMinutes % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}min`;
            } else {
                return `${minutes}min`;
            }
        }

        // --- AUTH ---
        async function initAuth() {
            // Não fazer login anônimo automaticamente
            // Usuário DEVE fazer login com Google ou Email
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                }
            } catch (error) { 
                console.error("Auth", error);
            }
        }

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                // Usuário logado - buscar ticket existente pelo UID
                await loadUserTicket();
                startListeners();
                // Esconder tela de login inicial e loading screen
                document.getElementById('initialLoginScreen').classList.add('hidden');
                document.getElementById('loadingScreen').classList.add('hidden');
                // Mostrar tela de seleção explicitamente após login
                goHome();
                // Mostrar botão de conta do cliente
                const clientBtn = document.getElementById('clientLogoutBtn');
                if (clientBtn) clientBtn.classList.remove('hidden');
                // Atualizar email se disponível
                const emailSpan = document.getElementById('userEmail');
                if (emailSpan && user.email) {
                    emailSpan.innerText = user.email.split('@')[0];
                } else if (emailSpan) {
                    emailSpan.innerText = 'Conta';
                }
            } else {
                // Sem usuário: mostrar tela de login inicial apenas se não estiver em modo PIN
                if (loggedInMode === 'barber' || loggedInMode === 'admin') {
                    document.getElementById('initialLoginScreen').classList.add('hidden');
                } else {
                    document.getElementById('initialLoginScreen').classList.remove('hidden');
                    document.getElementById('viewSelection').classList.add('hidden');
                    document.getElementById('viewQueue').classList.add('hidden');
                    document.getElementById('viewAdmin').classList.add('hidden');
                    const clientBtn = document.getElementById('clientLogoutBtn');
                    if (clientBtn) clientBtn.classList.add('hidden');
                }
            }
        });

        // --- TICKET VALIDATION ---
        async function loadUserTicket() {
            if (!currentUser) return;
            
            // Buscar ticket ativo do usuário pelo UID
            try {
                const q = query(
                    getCollection(QUEUE_COL),
                    where('userId', '==', currentUser.uid),
                    where('status', 'in', ['waiting', 'calling', 'cutting'])
                );
                const snapshot = await getDocs(q);
                
                if (!snapshot.empty) {
                    const ticketDoc = snapshot.docs[0];
                    myTicket = {
                        id: ticketDoc.id,
                        barberId: ticketDoc.data().barberId,
                        name: ticketDoc.data().name,
                        userId: currentUser.uid
                    };
                } else {
                    myTicket = null;
                }
            } catch (e) {
                console.error('Erro ao carregar ticket:', e);
            }
        }

        // --- DATA LISTENERS ---
        function stopListeners() {
            if (unsubscribeBarbersListener) {
                unsubscribeBarbersListener();
                unsubscribeBarbersListener = null;
            }
            if (unsubscribeQueueListener) {
                unsubscribeQueueListener();
                unsubscribeQueueListener = null;
            }
        }
        
        function startListeners() {
            // Parar listeners anteriores se existirem
            stopListeners();
            
            // Listen to Barbers
            unsubscribeBarbersListener = onSnapshot(getCollection(BARBERS_COL), (snapshot) => {
                const temp = [];
                snapshot.forEach(doc => temp.push({ id: doc.id, ...doc.data() }));
                barbersData = temp;
                renderBarberGrid(); 
                if(loggedInMode === 'admin') renderAdminList(); 
                
                // Atualizar selectedBarber se o barbeiro logado ou selecionado mudou
                if (selectedBarber) {
                    const freshBarber = barbersData.find(b => b.id === selectedBarber.id);
                    if (!freshBarber || !freshBarber.isActive) {
                        if (!loggedInMode) {
                            alert("Este barbeiro encerrou o expediente.");
                            goHome();
                        }
                    } else {
                        // Atualizar dados do barbeiro selecionado
                        selectedBarber = freshBarber;
                        // Forçar renderização se estiver na view de fila
                        if (!document.getElementById('viewQueue').classList.contains('hidden')) {
                            renderQueue();
                        }
                    }
                }
            }, (error) => {
                console.error("Barber Listener Error:", error);
                if (error.code === 'permission-denied') {
                    alert("⚠️ CONFIGURAÇÃO DO FIREBASE NECESSÁRIA:\n\n" +
                          "ERRO: Permissão Negada no Firestore\n\n" +
                          "═══════════════════════════════════════\n" +
                          "SOLUÇÃO RÁPIDA (APENAS PARA DESENVOLVIMENTO):\n" +
                          "═══════════════════════════════════════\n\n" +
                          "1. Vá para: https://console.firebase.google.com\n" +
                          "2. Selecione seu projeto\n" +
                          "3. Menu lateral > Firestore Database\n" +
                          "4. Aba 'Rules' (Regras)\n" +
                          "5. Substitua o conteúdo por:\n\n" +
                          "rules_version = '2';\n" +
                          "service cloud.firestore {\n" +
                          "  match /databases/{database}/documents {\n" +
                          "    match /{document=**} {\n" +
                          "      allow read, write: if request.auth != null;\n" +
                          "    }\n" +
                          "  }\n" +
                          "}\n\n" +
                          "6. Clique em 'Publicar'\n\n" +
                          "⚠️ IMPORTANTE: Esta regra permite qualquer usuário\n" +
                          "autenticado ler/escrever tudo. Para produção,\n" +
                          "implemente regras mais específicas!\n\n" +
                          "═══════════════════════════════════════\n" +
                          "PROBLEMA: Barbeiros precisam estar autenticados\n" +
                          "no Firebase para modificar a fila!");
                }
            });

            // Listen to Queue
            unsubscribeQueueListener = onSnapshot(getCollection(QUEUE_COL), (snapshot) => {
                const temp = [];
                snapshot.forEach(doc => temp.push({ id: doc.id, ...doc.data() }));
                
                // Verificar primeiro se o ticket do usuário foi marcado como no-show
                if (myTicket && !loggedInMode) {
                    const myTicketInSnapshot = temp.find(t => t.id === myTicket.id);
                    if (myTicketInSnapshot && myTicketInSnapshot.status === 'no-show') {
                        showNoShowModal();
                        clearMyTicket();
                    }
                }
                
                queueData = temp
                    .filter(item => item.status !== 'done' && item.status !== 'cancelled' && item.status !== 'no-show')
                    .sort((a, b) => a.joinedAt - b.joinedAt);

                checkMyTicketStatus(); // Verify if my ticket is still valid
                if (selectedBarber) renderQueue();
                renderBarberGrid(); 
            });
        }
        
        function checkMyTicketStatus() {
            if (!myTicket) {
                document.getElementById('homeActiveTicketNotice').classList.add('hidden');
                return;
            }

            // Check if ticket exists in current live data
            const ticketInDb = queueData.find(q => q.id === myTicket.id);
            
            if (!ticketInDb) {
                // Ticket disappeared (done, cancelled, or no-show)
                // Check if it was marked as no-show
                checkIfNoShow(myTicket.id);
            } else {
                // Check if ticket status changed to no-show while we're watching
                if (ticketInDb.status === 'no-show') {
                    showNoShowModal();
                    clearMyTicket();
                    return;
                }
                
                // Ticket exists, update display on Home
                const barber = barbersData.find(b => b.id === myTicket.barberId);
                if (barber) {
                    document.getElementById('homeActiveTicketNotice').classList.remove('hidden');
                    document.getElementById('homeTicketBarberName').innerText = barber.name;
                }
            }
        }
        
        async function checkIfNoShow(ticketId) {
            // Check in Firestore if the ticket was marked as no-show
            try {
                const docRef = getDocRef(QUEUE_COL, ticketId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const ticketData = docSnap.data();
                    if (ticketData.status === 'no-show') {
                        showNoShowModal();
                    }
                }
            } catch (e) {
                console.error('Erro ao verificar no-show:', e);
            }
            clearMyTicket();
        }
        
        function showNoShowModal() {
            if (!loggedInMode) { // Só mostrar para clientes
                document.getElementById('noShowModal').classList.remove('hidden');
            }
        }
        
        window.closeNoShowModal = () => {
            document.getElementById('noShowModal').classList.add('hidden');
            // Permitir que o cliente pegue nova senha
            clearMyTicket();
        };

        function clearMyTicket() {
            myTicket = null;
            document.getElementById('homeActiveTicketNotice').classList.add('hidden');
            if (selectedBarber && !loggedInMode) renderQueue(); // Refresh UI to show form again
        }

        // --- UI NAVIGATION ---
        window.goHome = () => {
            if (loggedInMode) return; 
            selectedBarber = null;
            document.getElementById('viewSelection').classList.remove('hidden');
            document.getElementById('viewQueue').classList.add('hidden');
            document.getElementById('viewAdmin').classList.add('hidden');
            document.getElementById('headerContext').innerText = "";
        };
        
        window.returnToMyQueue = () => {
            if (myTicket) {
                selectBarber(myTicket.barberId);
            }
        };

        window.selectBarber = (barberId) => {
            // CHECK LOCK: If user has a ticket for a DIFFERENT barber
            if (!loggedInMode && myTicket && myTicket.barberId !== barberId) {
                const currentBarber = barbersData.find(b => b.id === myTicket.barberId);
                const targetBarber = barbersData.find(b => b.id === barberId);
                
                document.getElementById('currentBarberNameModal').innerText = currentBarber ? currentBarber.name : "Outro";
                
                pendingBarberSwitch = barberId; // Store intended destination
                document.getElementById('modalConfirmChange').classList.remove('hidden');
                return;
            }

            const barber = barbersData.find(b => b.id === barberId);
            if (!barber) return;

            selectedBarber = barber;
            document.getElementById('viewSelection').classList.add('hidden');
            document.getElementById('viewQueue').classList.remove('hidden');
            
            document.getElementById('queueBarberName').innerText = barber.name;
            document.getElementById('displayBarberName').innerText = barber.name;
            document.getElementById('headerContext').innerText = `Vendo: ${barber.name}`;

            renderQueue();
        };

        // --- MODAL LOGIC FOR SWITCHING ---
        window.closeModal = (id) => {
            document.getElementById(id).classList.add('hidden');
            if (id === 'modalConfirmChange') pendingBarberSwitch = null;
        };

        window.openFinalWarning = () => {
            document.getElementById('modalConfirmChange').classList.add('hidden');
            document.getElementById('modalFinalWarning').classList.remove('hidden');
        };

        window.confirmSwitchBarber = async () => {
            document.getElementById('modalFinalWarning').classList.add('hidden');
            
            if (myTicket) {
                // Cancel old ticket
                await updateStatus(myTicket.id, 'cancelled');
                clearMyTicket();
            }
            
            // Navigate to new barber
            if (pendingBarberSwitch) {
                const targetId = pendingBarberSwitch;
                pendingBarberSwitch = null;
                selectBarber(targetId);
            }
        };
        
        window.confirmExitQueue = async () => {
            if (confirm("Deseja realmente sair da fila? Você perderá sua posição.")) {
                 if (myTicket) {
                    await updateStatus(myTicket.id, 'cancelled');
                    clearMyTicket();
                }
            }
        };

        // --- QUEUE LOGIC ---
        window.addToQueue = async () => {
            const name = document.getElementById('clientName').value.trim();
            if (!name || !selectedBarber) return;
            
            // Double check lock
            if (myTicket) { alert("Você já está em uma fila!"); return; }

            const btn = document.getElementById('joinBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            try {
                const docRef = await addDoc(getCollection(QUEUE_COL), {
                    name: name,
                    status: 'waiting',
                    joinedAt: Date.now(),
                    userId: currentUser.uid, // Vincular ao usuário
                    barberId: selectedBarber.id 
                });
                
                // SALVAR TICKET EM MEMÓRIA (não mais no localStorage)
                myTicket = { 
                    id: docRef.id, 
                    barberId: selectedBarber.id, 
                    name: name,
                    userId: currentUser.uid
                };

                document.getElementById('clientName').value = '';
                const msg = document.getElementById('joinMessage');
                msg.classList.remove('hidden');
                setTimeout(() => msg.classList.add('hidden'), 3000);
                
                renderQueue(); // Update UI immediately

            } catch (e) { console.error(e); alert("Erro ao entrar."); }
            finally { 
                btn.disabled = false; 
                btn.innerHTML = '<i class="fa-solid fa-ticket"></i> Pegar Senha';
            }
        };

        // --- ADMIN & BARBER LOGIN (Area Restrita) ---
        window.openLoginModal = () => {
            document.getElementById('loginModal').classList.remove('hidden');
            const pinEl = document.getElementById('pinInput');
            if (pinEl) pinEl.value = '';
            
            // Verificar se usuário já está autenticado
            if (currentUser) {
                // Esconder seção de autenticação
                document.getElementById('authSection').classList.add('hidden');
                // Mostrar indicador de usuário autenticado
                document.getElementById('authenticatedIndicator').classList.remove('hidden');
                document.getElementById('authUserEmail').textContent = currentUser.email || 'Usuário autenticado';
                // Atualizar subtítulo
                document.getElementById('modalSubtitle').textContent = 'Digite o PIN do barbeiro';
                // Focar no PIN
                setTimeout(() => pinEl.focus(), 100);
            } else {
                // Mostrar seção de autenticação
                document.getElementById('authSection').classList.remove('hidden');
                // Esconder indicador de usuário autenticado
                document.getElementById('authenticatedIndicator').classList.add('hidden');
                // Restaurar subtítulo
                document.getElementById('modalSubtitle').textContent = 'Barbeiros e Administradores';
            }
        };

        window.closeLoginModal = () => {
            document.getElementById('loginModal').classList.add('hidden');
            // Limpar campos
            document.getElementById('pinInput').value = '';
            document.getElementById('emailInput').value = '';
            document.getElementById('passwordInput').value = '';
        };
        
        // Login com Google
        window.loginWithGoogle = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                // Esconder seção de autenticação
                document.getElementById('authSection').classList.add('hidden');
                // Mostrar indicador de usuário autenticado
                document.getElementById('authenticatedIndicator').classList.remove('hidden');
                document.getElementById('authUserEmail').textContent = currentUser?.email || 'Usuário autenticado';
                // Atualizar subtítulo
                document.getElementById('modalSubtitle').textContent = 'Digite o PIN do barbeiro';
                // Alert de sucesso
                alert('✅ Login realizado com sucesso!\n\nAgora digite o PIN do barbeiro abaixo.');
                // Focar no campo de PIN
                document.getElementById('pinInput').focus();
            } catch (error) {
                console.error('Erro no login com Google:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    alert('Login cancelado.');
                } else if (error.code === 'auth/operation-not-allowed') {
                    alert('⚠️ Login com Google não está ativado no Firebase.\n\nVá em Authentication > Sign-in method > Google e ative.');
                } else {
                    alert('Erro ao fazer login com Google: ' + error.message);
                }
            }
        };
        
        // Login com Email
        window.loginWithEmail = async () => {
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            
            if (!email || !password) {
                alert('Preencha email e senha');
                return;
            }
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Esconder seção de autenticação
                document.getElementById('authSection').classList.add('hidden');
                // Mostrar indicador de usuário autenticado
                document.getElementById('authenticatedIndicator').classList.remove('hidden');
                document.getElementById('authUserEmail').textContent = email;
                // Atualizar subtítulo
                document.getElementById('modalSubtitle').textContent = 'Digite o PIN do barbeiro';
                // Alert de sucesso
                alert('✅ Login realizado com sucesso!\n\nAgora digite o PIN do barbeiro abaixo.');
                // Focar no campo de PIN
                document.getElementById('pinInput').focus();
            } catch (error) {
                console.error('Erro no login com email:', error);
                if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                    alert('Email ou senha incorretos.');
                } else if (error.code === 'auth/invalid-email') {
                    alert('Email inválido.');
                } else if (error.code === 'auth/operation-not-allowed') {
                    alert('⚠️ Login com Email/Senha não está ativado no Firebase.\n\nVá em Authentication > Sign-in method > Email/Password e ative.');
                } else {
                    alert('Erro ao fazer login: ' + error.message);
                }
            }
        };
        
        // Cadastro com Email
        window.registerWithEmail = async () => {
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            
            if (!email || !password) {
                alert('Preencha email e senha');
                return;
            }
            
            if (password.length < 6) {
                alert('A senha deve ter pelo menos 6 caracteres.');
                return;
            }
            
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                // Esconder seção de autenticação
                document.getElementById('authSection').classList.add('hidden');
                // Mostrar indicador de usuário autenticado
                document.getElementById('authenticatedIndicator').classList.remove('hidden');
                document.getElementById('authUserEmail').textContent = email;
                // Atualizar subtítulo
                document.getElementById('modalSubtitle').textContent = 'Digite o PIN do barbeiro';
                // Alert de sucesso
                alert('✅ Cadastro realizado com sucesso!\n\nAgora digite o PIN do barbeiro abaixo.');
                // Focar no campo de PIN
                document.getElementById('pinInput').focus();
            } catch (error) {
                console.error('Erro no cadastro:', error);
                if (error.code === 'auth/email-already-in-use') {
                    alert('Este email já está cadastrado. Tente fazer login.');
                } else if (error.code === 'auth/invalid-email') {
                    alert('Email inválido.');
                } else if (error.code === 'auth/weak-password') {
                    alert('Senha muito fraca. Use pelo menos 6 caracteres.');
                } else if (error.code === 'auth/operation-not-allowed') {
                    alert('⚠️ Cadastro com Email/Senha não está ativado no Firebase.\n\nVá em Authentication > Sign-in method > Email/Password e ative.');
                } else {
                    alert('Erro ao cadastrar: ' + error.message);
                }
            }
        };

        window.processLogin = () => {
            const pin = document.getElementById('pinInput').value;
            
            // VERIFICAR SE USUÁRIO ESTÁ AUTENTICADO NO FIREBASE
            if (!currentUser) {
                document.getElementById('barberAuthWarning').classList.remove('hidden');
                alert("⚠️ AUTENTICAÇÃO NECESSÁRIA\n\n" +
                      "Para acessar o painel de barbeiro/admin, você precisa:\n\n" +
                      "1. Fazer login com Google OU\n" +
                      "2. Fazer login com Email/Senha\n\n" +
                      "Depois de autenticado, digite o PIN do barbeiro.");
                return;
            }
            
            if (pin === MASTER_PIN) {
                loggedInMode = 'admin';
                document.getElementById('viewSelection').classList.add('hidden');
                document.getElementById('viewQueue').classList.add('hidden');
                document.getElementById('viewAdmin').classList.remove('hidden');
                document.getElementById('adminBtn').classList.add('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');
                document.getElementById('headerContext').innerText = "MODO ADMIN";
                // Ocultar tela de login inicial ao entrar por PIN
                document.getElementById('initialLoginScreen').classList.add('hidden');
                closeLoginModal();
                renderAdminList();
                return;
            }

            const barber = barbersData.find(b => b.pin === pin);
            if (barber) {
                loggedInMode = 'barber';
                loggedInBarberId = barber.id;
                selectedBarber = barber;
                
                document.getElementById('viewSelection').classList.add('hidden');
                document.getElementById('viewQueue').classList.remove('hidden');
                document.getElementById('viewAdmin').classList.add('hidden');
                document.getElementById('customerPanel').classList.add('hidden'); 
                document.getElementById('adminBtn').classList.add('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');
                document.getElementById('headerContext').innerText = `Painel: ${barber.name}`;
                document.getElementById('displayBarberName').innerText = barber.name + " (Você)";
                // Ocultar tela de login inicial ao entrar por PIN
                document.getElementById('initialLoginScreen').classList.add('hidden');
                closeLoginModal();
                renderQueue(); 
                return;
            }

            alert("PIN Incorreto ou Barbeiro não encontrado.");
        };

        window.logout = async () => {
            if (loggedInMode) {
                // Logout de barbeiro/admin (não desloga do Firebase)
                loggedInMode = null;
                loggedInBarberId = null;
                selectedBarber = null;
                
                document.getElementById('adminBtn').classList.remove('hidden');
                document.getElementById('logoutBtn').classList.add('hidden');
                document.getElementById('customerPanel').classList.remove('hidden');
                
                goHome();
            } else {
                // Logout completo do Firebase (cliente)
                try {
                    // Parar listeners ANTES de fazer signOut para evitar erros de permissão
                    stopListeners();
                    
                    // Limpar dados locais
                    myTicket = null;
                    queueData = [];
                    barbersData = [];
                    selectedBarber = null;
                    
                    // Fazer signOut
                    await signOut(auth);
                    
                    // onAuthStateChanged vai automaticamente mostrar a tela de login
                } catch (e) {
                    console.error('Erro ao sair:', e);
                    alert('Erro ao sair da conta. Tente novamente.');
                }
            }
        };

        // --- ADMIN FUNCTIONS ---
        window.addBarber = async () => {
            const name = document.getElementById('newBarberName').value.trim();
            const pin = document.getElementById('newBarberPin').value.trim();
            if (!name || !pin) return alert("Preencha nome e PIN");

            try {
                await addDoc(getCollection(BARBERS_COL), {
                    name, pin, isActive: true, createdAt: Date.now()
                });
                document.getElementById('newBarberName').value = '';
                document.getElementById('newBarberPin').value = '';
            } catch(e) { alert("Erro ao criar."); }
        };

        window.toggleBarberStatus = async (id, currentStatus) => {
            try {
                await updateDoc(getDocRef(BARBERS_COL, id), { isActive: !currentStatus });
            } catch(e) { console.error(e); }
        };

        window.deleteBarber = async (id) => {
            if(confirm("Tem certeza? Isso não apaga o histórico, mas remove o acesso.")) {
                await deleteDoc(getDocRef(BARBERS_COL, id));
            }
        };

        function renderAdminList() {
            const container = document.getElementById('adminBarberList');
            container.innerHTML = '';
            
            if (barbersData.length === 0) {
                container.innerHTML = '<p class="text-slate-500">Nenhum barbeiro cadastrado.</p>';
                return;
            }

            barbersData.forEach(b => {
                const item = document.createElement('div');
                item.className = 'bg-slate-700 p-4 rounded-lg flex justify-between items-center';
                item.innerHTML = `
                    <div>
                        <div class="font-bold text-white text-lg">${b.name}</div>
                        <div class="text-xs text-slate-400">PIN: ${b.pin}</div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <span class="text-xs uppercase font-bold ${b.isActive ? 'text-emerald-400' : 'text-slate-500'}">${b.isActive ? 'Ativo' : 'Inativo'}</span>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="toggle-${b.id}" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-500 transition-all duration-300 ${b.isActive ? 'right-0 border-emerald-500' : 'left-0'}" 
                                onclick="toggleBarberStatus('${b.id}', ${b.isActive})"/>
                                <label for="toggle-${b.id}" class="toggle-label block overflow-hidden h-6 rounded-full cursor-pointer ${b.isActive ? 'bg-emerald-500' : 'bg-slate-600'}"></label>
                            </div>
                        </div>
                        <button onclick="deleteBarber('${b.id}')" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // --- RENDERERS ---
        function renderBarberGrid() {
            const grid = document.getElementById('barberGrid');
            const activeBarbers = barbersData.filter(b => b.isActive);
            grid.innerHTML = '';

            if (activeBarbers.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center py-10">
                    <i class="fa-solid fa-store-slash text-4xl text-slate-600 mb-4"></i>
                    <p class="text-slate-400">Nenhum profissional disponível no momento.</p>
                </div>`;
                return;
            }

            activeBarbers.forEach(b => {
                const count = queueData.filter(q => q.barberId === b.id && q.status === 'waiting').length;
                const time = count * 20;

                // Check if this is the barber I'm queued for to add visual indicator
                const isMyBarber = myTicket && myTicket.barberId === b.id;
                
                // Check if barber is on pause
                const isPaused = b.isPaused === true;

                const card = document.createElement('div');
                card.onclick = () => selectBarber(b.id);
                card.className = `bg-slate-800 border ${isMyBarber ? 'border-amber-500 ring-2 ring-amber-500/30' : 'border-slate-700 hover:border-amber-500'} p-6 rounded-2xl cursor-pointer transition transform hover:scale-105 shadow-lg group relative overflow-hidden`;
                
                card.innerHTML = `
                    ${isMyBarber ? '<div class="absolute top-0 right-0 bg-amber-500 text-white text-[10px] uppercase font-bold px-2 py-1 rounded-bl-lg">Sua Fila</div>' : ''}
                    ${isPaused ? '<div class="absolute top-0 left-0 bg-orange-500 text-white text-[10px] uppercase font-bold px-2 py-1 rounded-br-lg flex items-center gap-1"><i class="fa-solid fa-pause"></i> Pausa</div>' : ''}
                    <div class="flex justify-between items-start mb-4">
                        <div class="bg-slate-700 p-3 rounded-full ${isPaused ? 'text-orange-400 bg-orange-500/20' : isMyBarber ? 'text-amber-500 bg-amber-500/20' : 'text-amber-500 group-hover:bg-amber-500 group-hover:text-white'} transition">
                            <i class="fa-solid ${isPaused ? 'fa-pause' : 'fa-user-tie'} text-2xl"></i>
                        </div>
                        <div class="text-right">
                            <span class="block text-2xl font-bold text-white">${count}</span>
                            <span class="text-xs text-slate-500 uppercase">Na Fila</span>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-1">${b.name}</h3>
                    ${isPaused ? '<p class="text-orange-400 text-sm font-medium"><i class="fa-solid fa-pause mr-1"></i> Em Pausa</p>' : '<p class="text-emerald-400 text-sm font-medium"><i class="fa-regular fa-clock mr-1"></i> ~${time} min espera</p>'}
                `;
                grid.appendChild(card);
            });
        }

        function renderQueue() {
            if (!selectedBarber) return;

            const listContainer = document.getElementById('queueList');
            const activeContainer = document.getElementById('activeCutContainer');
            
            const myQueue = queueData.filter(item => item.barberId === selectedBarber.id);
            const activeClient = myQueue.find(item => item.status === 'cutting');
            const callingClient = myQueue.find(item => item.status === 'calling');
            const waitingClients = myQueue.filter(item => item.status === 'waiting');

            document.getElementById('statWaiting').innerText = waitingClients.length;
            document.getElementById('statWaitingMobile').innerText = waitingClients.length;
            const time = waitingClients.length * 20;
            document.getElementById('statAvgMobile').innerText = time + "m";
            document.getElementById('statAvgDesktop').innerText = time;

            // --- USER STATUS LOGIC ---
            // Determine if user is in THIS queue (any active status)
            const myActiveTicket = myTicket && myTicket.barberId === selectedBarber.id ? myQueue.find(c => c.id === myTicket.id) : null;
            const amInThisQueue = myActiveTicket && ['waiting', 'calling', 'cutting'].includes(myActiveTicket.status);

            // Toggle Form vs Status
            if (!loggedInMode) {
                // Check if user got a no-show
                const noShowNotice = document.getElementById('noShowNotice');
                if (myTicket && myTicket.wasNoShow) {
                    document.getElementById('joinFormContainer').classList.add('hidden');
                    document.getElementById('activeTicketDisplay').classList.add('hidden');
                    if (noShowNotice) noShowNotice.classList.remove('hidden');
                } else if (amInThisQueue) {
                    document.getElementById('joinFormContainer').classList.add('hidden');
                    document.getElementById('activeTicketDisplay').classList.remove('hidden');
                    if (noShowNotice) noShowNotice.classList.add('hidden');
                    
                    // Show different status based on current state
                    const statusDisplay = document.getElementById('activeTicketDisplay');
                    if (myActiveTicket.status === 'calling') {
                        // Cliente está sendo chamado - mostrar em amarelo
                        statusDisplay.className = 'w-full bg-amber-500/20 border border-amber-500/50 rounded-xl p-6 text-center animate-pulse';
                        statusDisplay.innerHTML = `
                            <div class="text-amber-500 text-4xl mb-2"><i class="fa-solid fa-bell-concierge"></i></div>
                            <h3 class="text-white font-bold text-2xl mb-1">VOCÊ ESTÁ SENDO CHAMADO!</h3>
                            <p class="text-amber-400 text-lg mb-4 font-bold">Dirija-se à cadeira agora</p>
                            <div class="bg-slate-900/50 rounded-lg p-3">
                                <p class="text-amber-500 text-sm">O barbeiro está te aguardando</p>
                            </div>
                        `;
                    } else if (myActiveTicket.status === 'cutting') {
                        // Cliente está cortando - mostrar em verde
                        statusDisplay.className = 'w-full bg-emerald-500/20 border border-emerald-500/50 rounded-xl p-6 text-center';
                        statusDisplay.innerHTML = `
                            <div class="text-emerald-500 text-4xl mb-2"><i class="fa-solid fa-chair"></i></div>
                            <h3 class="text-white font-bold text-2xl mb-1">VOCÊ ESTÁ SENDO ATENDIDO</h3>
                            <p class="text-emerald-400 text-sm mb-4">Seu atendimento está em andamento</p>
                            <div class="bg-slate-900/50 rounded-lg p-3">
                                <p class="text-emerald-500 text-sm">Aproveite seu corte!</p>
                            </div>
                        `;
                    } else {
                        // Cliente está aguardando - mostrar posição
                        statusDisplay.className = 'w-full bg-amber-500/10 border border-amber-500/30 rounded-xl p-6 text-center';
                        const myPos = waitingClients.findIndex(c => c.id === myTicket.id) + 1;
                        statusDisplay.innerHTML = `
                            <div class="text-amber-500 text-4xl mb-2"><i class="fa-solid fa-ticket-alt"></i></div>
                            <h3 class="text-white font-bold text-lg mb-1">Você está na fila!</h3>
                            <p class="text-slate-400 text-sm mb-4">Acompanhe sua posição no painel ao lado.</p>
                            
                            <div class="bg-slate-900/50 rounded-lg p-3 mb-4">
                                <p class="text-xs text-slate-500 uppercase">Sua Posição</p>
                                <p class="text-2xl font-bold text-white">${myPos}º</p>
                            </div>
                            
                            <button onclick="confirmExitQueue()" class="text-red-400 hover:text-red-300 text-sm underline">
                                Cancelar minha vez e sair
                            </button>
                        `;
                    }
                } else {
                    document.getElementById('joinFormContainer').classList.remove('hidden');
                    document.getElementById('activeTicketDisplay').classList.add('hidden');
                    if (noShowNotice) noShowNotice.classList.add('hidden');
                }
            }

            if (activeClient) {
                activeContainer.classList.remove('hidden');
                const contentDiv = document.getElementById('activeCutContent');
                contentDiv.className = 'bg-gradient-to-r from-emerald-900/40 to-slate-800 border border-emerald-500/30 rounded-2xl p-6 flex items-center justify-between shadow-lg relative overflow-hidden';
                contentDiv.innerHTML = `
                    <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-emerald-500 blur-3xl opacity-20 rounded-full"></div>
                    <div class="flex items-center gap-6 relative z-10">
                        <div class="bg-emerald-500/20 p-4 rounded-full text-emerald-400 animate-pulse">
                            <i class="fa-solid fa-chair text-3xl"></i>
                        </div>
                        <div>
                            <p class="text-emerald-400 font-bold text-sm uppercase tracking-widest mb-1">Cortando Agora</p>
                            <h3 class="text-3xl md:text-4xl font-bold text-white">${activeClient.name}</h3>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 ${loggedInMode === 'admin' || (loggedInMode === 'barber' && loggedInBarberId === selectedBarber.id) ? '' : 'hidden'}">
                        <button onclick="openPauseModal()" class="bg-amber-600 hover:bg-amber-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition flex flex-col items-center">
                            <i class="fa-solid fa-pause text-xl mb-1"></i>
                            <span class="text-xs">Pausar</span>
                        </button>
                        <button onclick="finishCut('${activeClient.id}')" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition flex flex-col items-center">
                            <i class="fa-solid fa-check text-xl mb-1"></i>
                            <span class="text-xs">Finalizar</span>
                        </button>
                    </div>
                `;
            } else if (callingClient) {
                activeContainer.classList.remove('hidden');
                const contentDiv = document.getElementById('activeCutContent');
                contentDiv.className = 'bg-gradient-to-r from-amber-900/40 to-slate-800 border border-amber-500/30 rounded-2xl p-6 flex items-center justify-between shadow-lg relative overflow-hidden';
                contentDiv.innerHTML = `
                    <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-amber-500 blur-3xl opacity-20 rounded-full"></div>
                    <div class="flex items-center gap-6 relative z-10">
                        <div class="bg-amber-500/20 p-4 rounded-full text-amber-400 animate-pulse">
                            <i class="fa-solid fa-chair text-3xl"></i>
                        </div>
                        <div>
                            <p class="text-amber-400 font-bold text-sm uppercase tracking-widest mb-1">Chamando</p>
                            <h3 class="text-3xl md:text-4xl font-bold text-white">${callingClient.name}</h3>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 ${loggedInMode === 'admin' || (loggedInMode === 'barber' && loggedInBarberId === selectedBarber.id) ? '' : 'hidden'}">
                        <button onclick="clientArrived('${callingClient.id}')" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition flex items-center gap-2">
                            <i class="fa-solid fa-check text-xl"></i>
                            <span>CHEGOU</span>
                        </button>
                        <button onclick="clientNoShow('${callingClient.id}')" class="bg-red-600 hover:bg-red-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition flex items-center gap-2">
                            <i class="fa-solid fa-xmark text-xl"></i>
                            <span>NÃO CHEGOU</span>
                        </button>
                    </div>
                `;
            } else if (selectedBarber.isPaused && (loggedInMode === 'barber' && loggedInBarberId === selectedBarber.id)) {
                // Show pause status and resume button
                activeContainer.classList.remove('hidden');
                const contentDiv = document.getElementById('activeCutContent');
                contentDiv.className = 'bg-gradient-to-r from-orange-900/40 to-slate-800 border border-orange-500/30 rounded-2xl p-6 flex items-center justify-between shadow-lg relative overflow-hidden';
                contentDiv.innerHTML = `
                    <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-orange-500 blur-3xl opacity-20 rounded-full"></div>
                    <div class="flex items-center gap-6 relative z-10">
                        <div class="bg-orange-500/20 p-4 rounded-full text-orange-400 animate-pulse">
                            <i class="fa-solid fa-pause text-3xl"></i>
                        </div>
                        <div>
                            <p class="text-orange-400 font-bold text-sm uppercase tracking-widest mb-1">Você está em pausa</p>
                            <h3 class="text-2xl md:text-3xl font-bold text-white">Clique para retomar</h3>
                        </div>
                    </div>
                    
                    <button onclick="resumeBarber()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition flex flex-col items-center">
                        <i class="fa-solid fa-play text-xl mb-1"></i>
                        <span class="text-xs">Retomar</span>
                    </button>
                `;
            } else {
                activeContainer.classList.add('hidden');
            }

            listContainer.innerHTML = '';
            if (waitingClients.length === 0 && !activeClient) {
                listContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-slate-600 fade-in">
                        <i class="fa-solid fa-mug-hot text-5xl mb-4 opacity-30"></i>
                        <p class="text-lg">Tudo calmo para ${selectedBarber.name}.</p>
                    </div>
                `;
            } else {
                waitingClients.forEach((client, index) => {
                    // Check if this is ME
                    const isMe = myTicket && myTicket.id === client.id;

                    const card = document.createElement('div');
                    // Add special class if it is me
                    card.className = `bg-slate-800 border ${isMe ? 'border-amber-500 status-mine' : 'border-slate-700'} rounded-xl p-4 mb-3 flex justify-between items-center shadow-sm fade-in status-waiting transition-all`;
                    
                    const showControls = loggedInMode === 'admin' || (loggedInMode === 'barber' && loggedInBarberId === selectedBarber.id);
                    
                    card.innerHTML = `
                        <div class="flex items-center gap-4 flex-1">
                            <div class="flex items-center justify-center w-10 h-10 rounded-full ${isMe ? 'bg-amber-500 text-white shadow-lg' : 'bg-slate-700 text-slate-400'} font-bold relative">
                                ${index + 1}
                                ${isMe ? '<div class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>' : ''}
                            </div>
                            <div>
                                <h4 class="font-bold text-lg text-white">${client.name} ${isMe ? '<span class="text-xs bg-amber-500 text-white px-1.5 rounded ml-2">VOCÊ</span>' : ''}</h4>
                                <span class="text-xs text-slate-500"><i class="fa-regular fa-clock"></i> Há ${formatElapsedTime(client.joinedAt)}</span>
                            </div>
                        </div>
                        ${showControls ? `
                        <div class="flex gap-2 ml-4">
                            <button onclick="callClient('${client.id}')" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-3 rounded-lg shadow font-bold flex items-center gap-2">
                                <span>CHAMAR</span>
                            </button>
                            <button onclick="removeClient('${client.id}')" class="bg-slate-700 hover:bg-red-500/80 text-white p-3 rounded-lg"><i class="fa-solid fa-trash"></i></button>
                        </div>` : ''}
                    `;
                    listContainer.appendChild(card);
                });
            }
        }

        // Global Actions
        window.callClient = async (id) => {
            // Change to 'calling' status instead of 'cutting'
            try {
                await updateDoc(getDocRef(QUEUE_COL, id), { status: 'calling' });
            } catch(e) { console.error(e); }
        };
        
        window.clientArrived = async (id) => {
            // Client arrived, change to cutting
            try {
                await updateDoc(getDocRef(QUEUE_COL, id), { status: 'cutting' });
            } catch(e) { console.error(e); }
        };
        
        window.clientNoShow = async (id) => {
            // Client didn't show up, mark as no-show
            try {
                await updateDoc(getDocRef(QUEUE_COL, id), { status: 'no-show' });
                
                // If this is my ticket, mark it
                if (myTicket && myTicket.id === id) {
                    myTicket.wasNoShow = true;
                }
            } catch(e) { console.error(e); }
        };
        
        window.clearNoShowAndRejoin = () => {
            // Clear the no-show flag and show form again
            if (myTicket) {
                myTicket.wasNoShow = false;
                clearMyTicket();
            }
        };
        
        window.finishCut = async (id) => {
            try {
                await updateDoc(getDocRef(QUEUE_COL, id), { 
                    status: 'done',
                    completedAt: Date.now()
                });
            } catch(e) { console.error(e); }
        };
        
        window.removeClient = async (id) => {
            if(confirm("Remover da fila?")) updateStatus(id, 'cancelled');
        };

        async function updateStatus(docId, newStatus) {
            try { await updateDoc(getDocRef(QUEUE_COL, docId), { status: newStatus }); }
            catch(e) { console.error(e); }
        }

        // --- PAUSE SYSTEM ---
        window.openPauseModal = () => {
            if (loggedInMode === 'barber') {
                document.getElementById('pauseModal').classList.remove('hidden');
            }
        };

        window.closePauseModal = () => {
            document.getElementById('pauseModal').classList.add('hidden');
        };

        window.setPauseReason = async (reason) => {
            if (!loggedInBarberId) return;
            
            try {
                await updateDoc(getDocRef(BARBERS_COL, loggedInBarberId), {
                    isPaused: true,
                    pauseReason: reason,
                    pausedAt: Date.now()
                });
                closePauseModal();
                renderQueue();
            } catch (e) {
                console.error("Erro ao pausar:", e);
            }
        };

        window.resumeBarber = async () => {
            if (!loggedInBarberId) return;
            
            try {
                await updateDoc(getDocRef(BARBERS_COL, loggedInBarberId), {
                    isPaused: false,
                    pauseReason: null,
                    pausedAt: null
                });
                closePauseModal(); // Fechar modal caso esteja aberto
                // Renderização será acionada pelo listener automático
            } catch (e) {
                console.error("Erro ao retomar:", e);
            }
        };

        // --- ADMIN DASHBOARD FUNCTIONS ---
        let chartsInstances = {};

        window.switchAdminTab = (tab) => {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('bg-amber-600', 'text-white');
                b.classList.add('text-slate-400', 'hover:text-white');
            });
            
            // Show selected tab
            document.getElementById('tab-content-' + tab).classList.remove('hidden');
            document.getElementById('tab-' + tab).classList.add('bg-amber-600', 'text-white');
            document.getElementById('tab-' + tab).classList.remove('text-slate-400', 'hover:text-white');
            
            // Load charts if dashboard
            if (tab === 'dashboard') {
                setTimeout(() => initDashboardCharts(), 100);
            }
        };

        function initDashboardCharts() {
            // Garantir locale pt-BR para formatações internas do Chart
            if (window.Chart && Chart.defaults) {
                Chart.defaults.locale = 'pt-BR';
            }
            // Collect data from queueData
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayMs = today.getTime();

            // Filter today's completed cuts
            const completedToday = queueData.filter(q => q.status === 'done' && q.completedAt && q.completedAt >= todayMs);
            
            // Group by barber for completed cuts
            const completedByBarber = {};
            completedToday.forEach(q => {
                if (!completedByBarber[q.barberId]) completedByBarber[q.barberId] = 0;
                completedByBarber[q.barberId]++;
            });

            // Calculate no-shows (cancelled on waiting)
            const noShowsToday = queueData.filter(q => q.status === 'cancelled' && q.joinedAt >= todayMs && q.status !== 'done');
            const noShowsByBarber = {};
            noShowsToday.forEach(q => {
                if (!noShowsByBarber[q.barberId]) noShowsByBarber[q.barberId] = 0;
                noShowsByBarber[q.barberId]++;
            });

            // Calculate average time between finishes
            const avgTimeByBarber = {};
            barbersData.forEach(barber => {
                const barberCompletedToday = completedToday.filter(q => q.barberId === barber.id).sort((a, b) => a.completedAt - b.completedAt);
                
                if (barberCompletedToday.length > 1) {
                    let totalTime = 0;
                    for (let i = 1; i < barberCompletedToday.length; i++) {
                        const timeDiff = (barberCompletedToday[i].completedAt - barberCompletedToday[i-1].completedAt) / 60000; // Convert to minutes
                        totalTime += timeDiff;
                    }
                    avgTimeByBarber[barber.id] = Math.round(totalTime / (barberCompletedToday.length - 1));
                } else if (barberCompletedToday.length === 1) {
                    avgTimeByBarber[barber.id] = 20; // Default estimate
                } else {
                    avgTimeByBarber[barber.id] = 0;
                }
            });

            const barberLabels = barbersData.map(b => b.name);
            const completedData = barbersData.map(b => completedByBarber[b.id] || 0);
            const noShowsData = barbersData.map(b => noShowsByBarber[b.id] || 0);
            const avgTimeData = barbersData.map(b => avgTimeByBarber[b.id] || 0);

            // Chart 1: Completed Cuts
            const ctx1 = document.getElementById('chartCompletedCuts');
            if (ctx1) {
                if (chartsInstances.completedCuts) chartsInstances.completedCuts.destroy();
                chartsInstances.completedCuts = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: barberLabels,
                        datasets: [{
                            label: 'Cortes Concluídos Hoje',
                            data: completedData,
                            backgroundColor: '#10b981',
                            borderColor: '#059669',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { labels: { color: '#e2e8f0' } },
                            tooltip: {
                                callbacks: {
                                    title: (items) => items[0]?.label || '',
                                    label: (context) => {
                                        const v = context.parsed?.y ?? context.parsed ?? context.raw;
                                        return `Cortes: ${v}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#475569' }
                            },
                            x: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#475569' }
                            }
                        }
                    }
                });
            }

            // Chart 2: No-Shows
            const ctx2 = document.getElementById('chartNoShows');
            if (ctx2) {
                if (chartsInstances.noShows) chartsInstances.noShows.destroy();
                chartsInstances.noShows = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: barberLabels,
                        datasets: [{
                            label: 'Faltas Hoje',
                            data: noShowsData,
                            backgroundColor: '#ef4444',
                            borderColor: '#dc2626',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { labels: { color: '#e2e8f0' } },
                            tooltip: {
                                callbacks: {
                                    title: (items) => items[0]?.label || '',
                                    label: (context) => {
                                        const v = context.parsed?.y ?? context.parsed ?? context.raw;
                                        return `Faltas: ${v}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#475569' }
                            },
                            x: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#475569' }
                            }
                        }
                    }
                });
            }

            // Chart 3: Average Time
            const ctx3 = document.getElementById('chartAvgTime');
            if (ctx3) {
                if (chartsInstances.avgTime) chartsInstances.avgTime.destroy();
                chartsInstances.avgTime = new Chart(ctx3, {
                    type: 'line',
                    data: {
                        labels: barberLabels,
                        datasets: [{
                            label: 'Tempo Médio (minutos)',
                            data: avgTimeData,
                            borderColor: '#3b82f6',
                            backgroundColor: '#3b82f630',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#3b82f6',
                            pointBorderColor: '#1e40af',
                            pointBorderWidth: 2,
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { labels: { color: '#e2e8f0' } },
                            tooltip: {
                                callbacks: {
                                    title: (items) => items[0]?.label || '',
                                    label: (context) => {
                                        const v = context.parsed?.y ?? context.parsed ?? context.raw;
                                        return `Tempo: ${v} min`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#475569' }
                            },
                            x: {
                                ticks: { color: '#94a3b8' },
                                grid: { color: '#475569' }
                            }
                        }
                    }
                });
            }
        }

        // Init
        initAuth();

    </script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        // Variável para armazenar o evento de instalação
        let deferredPrompt = null;
        let installPromptShown = false;
        
        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('✅ Service Worker registrado com sucesso:', registration.scope);
                        
                        // Verificar atualizações periodicamente
                        setInterval(() => {
                            registration.update();
                        }, 60000);
                    })
                    .catch(error => {
                        console.error('❌ Falha ao registrar Service Worker:', error);
                    });
            });
        } else {
            console.warn('⚠️ Service Worker não é suportado neste navegador');
        }
        
        // Capturar evento beforeinstallprompt e mostrar botão
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevenir o minibar padrão do navegador
            e.preventDefault();
            
            // Armazenar o evento
            deferredPrompt = e;
            installPromptShown = true;
            
            // Mostrar botão de instalação
            const installBtn = document.getElementById('installBtn');
            if (installBtn) {
                installBtn.classList.remove('hidden');
                console.log('✅ Evento beforeinstallprompt capturado - Botão de instalação ativado!');
            }
        });
        
        // Função para instalar o app
        window.installPWA = async () => {
            if (deferredPrompt) {
                try {
                    // Mostrar prompt de instalação
                    deferredPrompt.prompt();
                    
                    // Aguardar resposta do usuário
                    const { outcome } = await deferredPrompt.userChoice;
                    
                    if (outcome === 'accepted') {
                        console.log('✅ Usuário aceitou instalar o app!');
                        // Esconder botão após instalação
                        const installBtn = document.getElementById('installBtn');
                        if (installBtn) {
                            installBtn.classList.add('hidden');
                        }
                    } else {
                        console.log('❌ Usuário recusou instalar o app');
                    }
                    
                    // Limpar o evento
                    deferredPrompt = null;
                } catch (error) {
                    console.error('Erro ao instalar PWA:', error);
                }
            } else {
                // Se o evento não estiver disponível, informar ao usuário
                showInstallGuide();
            }
        };
        
        // Função para mostrar guia de instalação manual
        function showInstallGuide() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const isAndroid = /Android/.test(navigator.userAgent);
            const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            const isEdge = /Edg/.test(navigator.userAgent);
            const isFirefox = /Firefox/.test(navigator.userAgent);
            
            let guideText = 'Para instalar este app:\n\n';
            
            if (isIOS) {
                guideText += '📱 iPhone/iPad:\n' +
                    '1. Abra Safari\n' +
                    '2. Clique no ícone de compartilhamento (caixa com seta)\n' +
                    '3. Selecione "Adicionar à tela inicial"\n' +
                    '4. Nomeie e clique em "Adicionar"';
            } else if (isAndroid && isChrome) {
                guideText += '🤖 Chrome Android:\n' +
                    '1. Abra o menu (⋮) no canto superior direito\n' +
                    '2. Selecione "Instalar app" ou "Adicionar à tela inicial"\n' +
                    '3. Confirme a instalação';
            } else if (isAndroid && isEdge) {
                guideText += '🤖 Edge Android:\n' +
                    '1. Abra o menu (⋮) no canto inferior direito\n' +
                    '2. Selecione "Instalar app"\n' +
                    '3. Confirme a instalação';
            } else if (isAndroid && isFirefox) {
                guideText += '🤖 Firefox Android:\n' +
                    '1. Abra o menu (⋮) no canto superior direito\n' +
                    '2. Selecione "Instalar"\n' +
                    '3. Confirme a instalação';
            } else {
                guideText += '💻 Navegador Desktop:\n' +
                    '1. Abra o menu do navegador\n' +
                    '2. Procure por "Instalar app" ou "Adicionar à tela de início"\n' +
                    '3. Confirme a instalação';
            }
            
            alert(guideText);
        }
        
        // Ouvir quando o app foi instalado
        window.addEventListener('appinstalled', () => {
            console.log('✅ PWA instalado com sucesso!');
            // Esconder botão de instalação
            const installBtn = document.getElementById('installBtn');
            if (installBtn) {
                installBtn.classList.add('hidden');
            }
            deferredPrompt = null;
        });
        
        // Diagnosticar problemas de PWA após 5 segundos
        setTimeout(() => {
            if (!installPromptShown && deferredPrompt === null) {
                console.warn('⚠️ beforeinstallprompt não foi disparado. Possíveis causas:');
                console.warn('  - Sem HTTPS (PWA requer HTTPS, exceto em localhost)');
                console.warn('  - manifest.json não está acessível');
                console.warn('  - Service Worker não registrou corretamente');
                console.warn('  - Navegador não suporta PWA');
                console.warn('  - App já está instalado');
                
                // Verificar se o manifest pode ser acessado
                fetch('manifest.json')
                    .then(r => {
                        if (r.ok) {
                            console.log('✅ manifest.json está acessível');
                        } else {
                            console.error('❌ manifest.json retornou status:', r.status);
                        }
                    })
                    .catch(e => console.error('❌ Erro ao acessar manifest.json:', e));
            }
        }, 5000);
    </script>
</body>
</html>
