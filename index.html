<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BarberQueue - Multi Barbeiros</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .status-waiting { border-left: 4px solid #f59e0b; }
        .status-cutting { border-left: 4px solid #10b981; border: 2px solid #10b981; background-color: rgba(16, 185, 129, 0.1); }
        
        /* Toggle Switch CSS */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #10b981;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #10b981;
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700 p-4 shadow-lg flex justify-between items-center z-10">
        <div class="flex items-center gap-3 cursor-pointer" onclick="goHome()">
            <i class="fa-solid fa-scissors text-amber-500 text-2xl"></i>
            <h1 class="text-xl font-bold tracking-tight">Barber<span class="text-amber-500">Queue</span></h1>
        </div>
        <div class="flex gap-2 items-center">
            <!-- Mostra qual barbeiro está selecionado ou logado -->
            <span id="headerContext" class="text-xs font-bold text-slate-400 uppercase tracking-widest hidden md:block"></span>
            
            <button onclick="openLoginModal()" id="adminBtn" class="bg-slate-700 hover:bg-slate-600 text-xs px-3 py-2 rounded-lg transition border border-slate-600">
                <i class="fa-solid fa-lock mr-1"></i> Área Restrita
            </button>
            <button onclick="logout()" id="logoutBtn" class="hidden bg-red-600 hover:bg-red-500 text-xs px-3 py-2 rounded-lg transition border border-red-400">
                <i class="fa-solid fa-right-from-bracket mr-1"></i> Sair
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 relative overflow-hidden flex flex-col">

        <!-- VIEW 1: SELECTION SCREEN (Home) -->
        <div id="viewSelection" class="absolute inset-0 z-30 bg-slate-900 flex flex-col items-center justify-center p-6 fade-in">
            <h2 class="text-3xl font-bold text-white mb-2 text-center">Escolha seu Profissional</h2>
            <p class="text-slate-400 mb-8 text-center">Selecione quem vai te atender hoje.</p>
            
            <div id="barberGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 w-full max-w-4xl">
                <!-- Barber Cards Injected Here -->
                <div class="col-span-full text-center text-slate-500">Carregando barbeiros...</div>
            </div>
        </div>

        <!-- VIEW 2: QUEUE INTERFACE (Split Screen) -->
        <div id="viewQueue" class="flex-1 flex flex-col md:flex-row h-full hidden">
            
            <!-- Left: Add to Queue (Customer) -->
            <section id="customerPanel" class="w-full md:w-1/3 bg-slate-800/50 p-6 flex flex-col justify-center items-center border-r border-slate-700 relative z-20 transition-all duration-300">
                <button onclick="goHome()" class="absolute top-4 left-4 text-slate-500 hover:text-white flex items-center gap-2 text-sm">
                    <i class="fa-solid fa-arrow-left"></i> Voltar
                </button>

                <div class="max-w-sm w-full space-y-6 mt-8 md:mt-0">
                    <div class="text-center">
                        <div class="mb-2 inline-block p-3 rounded-full bg-slate-800 border border-slate-600">
                            <i class="fa-solid fa-user-tag text-amber-500 text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-white mb-1">Entrar na Fila</h2>
                        <p class="text-slate-400 text-sm">Fila de: <strong id="queueBarberName" class="text-white">--</strong></p>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-semibold text-slate-400 mb-1 uppercase tracking-wider">Seu Nome</label>
                            <input type="text" id="clientName" placeholder="Ex: João Silva" 
                                class="w-full bg-slate-900 border border-slate-700 text-white text-lg px-4 py-3 rounded-xl focus:outline-none focus:border-amber-500 focus:ring-1 focus:ring-amber-500 transition shadow-inner">
                        </div>
                        <button onclick="addToQueue()" id="joinBtn" 
                            class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-400 hover:to-orange-500 text-white font-bold py-4 rounded-xl shadow-lg transform active:scale-95 transition flex items-center justify-center gap-2">
                            <i class="fa-solid fa-ticket"></i> Pegar Senha
                        </button>
                    </div>
                    
                    <div id="joinMessage" class="hidden text-center p-3 rounded-lg bg-emerald-500/20 text-emerald-400 text-sm font-medium fade-in">
                        <i class="fa-solid fa-check-circle mr-1"></i> Você entrou na fila!
                    </div>
                </div>

                <!-- Stats Mobile -->
                <div class="mt-8 grid grid-cols-2 gap-4 w-full max-w-sm md:hidden">
                    <div class="bg-slate-700/50 p-3 rounded-lg text-center">
                        <div class="text-2xl font-bold text-white" id="statWaitingMobile">0</div>
                        <div class="text-xs text-slate-400">Na espera</div>
                    </div>
                    <div class="bg-slate-700/50 p-3 rounded-lg text-center">
                        <div class="text-2xl font-bold text-emerald-400" id="statAvgMobile">--</div>
                        <div class="text-xs text-slate-400">Tempo Médio</div>
                    </div>
                </div>
            </section>

            <!-- Right: Queue Display (TV/Barber) -->
            <section class="flex-1 bg-slate-900 p-4 md:p-8 flex flex-col h-full overflow-hidden">
                <div class="mb-6 flex justify-between items-end border-b border-slate-800 pb-4">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-bold text-white">Fila de <span id="displayBarberName" class="text-amber-500">--</span></h2>
                        <p class="text-slate-400 text-sm mt-1">Atualizado em tempo real</p>
                    </div>
                    <div class="hidden md:flex gap-6 text-right">
                        <div>
                            <span class="block text-3xl font-bold text-white" id="statWaiting">0</span>
                            <span class="text-xs text-slate-500 uppercase font-bold">Pessoas</span>
                        </div>
                        <div>
                            <span class="block text-3xl font-bold text-emerald-400"><span id="statAvgDesktop">0</span><span class="text-sm text-emerald-600 ml-1">min</span></span>
                            <span class="text-xs text-slate-500 uppercase font-bold">Estimado</span>
                        </div>
                    </div>
                </div>

                <!-- Active Cut -->
                <div id="activeCutContainer" class="hidden mb-6 fade-in">
                    <div class="bg-gradient-to-r from-emerald-900/40 to-slate-800 border border-emerald-500/30 rounded-2xl p-6 flex items-center justify-between shadow-lg relative overflow-hidden">
                        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-emerald-500 blur-3xl opacity-20 rounded-full"></div>
                        <div class="flex items-center gap-6 relative z-10">
                            <div class="bg-emerald-500/20 p-4 rounded-full text-emerald-400 animate-pulse">
                                <i class="fa-solid fa-chair text-3xl"></i>
                            </div>
                            <div>
                                <p class="text-emerald-400 font-bold text-sm uppercase tracking-widest mb-1">Cortando Agora</p>
                                <h3 class="text-3xl md:text-4xl font-bold text-white" id="activeClientName">Cliente</h3>
                            </div>
                        </div>
                        
                        <div class="barber-controls hidden flex gap-3">
                            <button onclick="finishCut()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition flex flex-col items-center">
                                <i class="fa-solid fa-check text-xl mb-1"></i>
                                <span class="text-xs">Finalizar</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Queue List -->
                <div class="flex-1 overflow-y-auto pr-2" id="queueList">
                    <div class="flex flex-col items-center justify-center h-64 text-slate-600">
                        <i class="fa-solid fa-spinner fa-spin text-4xl mb-4 opacity-50"></i>
                        <p>Carregando...</p>
                    </div>
                </div>
            </section>
        </div>

        <!-- VIEW 3: ADMIN PANEL -->
        <div id="viewAdmin" class="absolute inset-0 z-40 bg-slate-900 p-6 md:p-12 overflow-y-auto hidden">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-8 border-b border-slate-700 pb-4">
                    <h2 class="text-3xl font-bold text-white"><i class="fa-solid fa-users-gear mr-2 text-amber-500"></i>Gestão de Barbeiros</h2>
                    <button onclick="logout()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-times text-xl"></i> Fechar</button>
                </div>

                <!-- Add New Barber -->
                <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 mb-8">
                    <h3 class="text-lg font-bold text-white mb-4">Adicionar Novo Profissional</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="newBarberName" placeholder="Nome (Ex: Carlos)" class="bg-slate-900 border border-slate-600 rounded-lg p-3 text-white">
                        <input type="text" id="newBarberPin" placeholder="PIN de Acesso (Ex: 1234)" class="bg-slate-900 border border-slate-600 rounded-lg p-3 text-white">
                        <button onclick="addBarber()" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg p-3">
                            <i class="fa-solid fa-plus mr-1"></i> Adicionar
                        </button>
                    </div>
                </div>

                <!-- List Barbers -->
                <h3 class="text-lg font-bold text-white mb-4">Equipe Cadastrada</h3>
                <div id="adminBarberList" class="space-y-3">
                    <!-- Injected via JS -->
                </div>
            </div>
        </div>

    </main>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 fade-in">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700 w-full max-w-xs text-center">
            <i class="fa-solid fa-lock text-amber-500 text-3xl mb-4"></i>
            <h3 class="text-xl font-bold text-white mb-2">Acesso Restrito</h3>
            <p class="text-slate-400 text-sm mb-6">Digite seu PIN ou a Senha Mestra</p>
            <input type="password" id="pinInput" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white text-center text-2xl tracking-widest mb-4 focus:border-amber-500 focus:outline-none">
            <div class="flex gap-2">
                <button onclick="closeLoginModal()" class="flex-1 py-3 rounded-lg bg-slate-700 text-slate-300 hover:bg-slate-600">Voltar</button>
                <button onclick="processLogin()" class="flex-1 py-3 rounded-lg bg-amber-600 text-white font-bold hover:bg-amber-500">Entrar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
        
        const userFirebaseConfig = {
            apiKey: "AIzaSyCyTJVlgvkLa2-SUNaxAlOiTezcXfjiP64",
            authDomain: "seu-vizinho-barbearia.firebaseapp.com",
            projectId: "seu-vizinho-barbearia",
            storageBucket: "seu-vizinho-barbearia.firebasestorage.app",
            messagingSenderId: "25346983688",
            appId: "1:25346983688:web:727308786e34874ae50ebd"
        };

        let firebaseConfig;
        let useInternalPath = false;

        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            useInternalPath = true;
        } else {
            firebaseConfig = userFirebaseConfig;
            useInternalPath = false;
        }
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Constants
        const QUEUE_COL = 'queue';
        const BARBERS_COL = 'barbers';
        const MASTER_PIN = "9999"; 

        // State
        let currentUser = null;
        let queueData = [];
        let barbersData = [];
        let selectedBarber = null; // Object: { id, name, ... }
        let loggedInMode = null; // 'admin' or 'barber'
        let loggedInBarberId = null; 

        // Helper Functions for Paths
        function getCollection(colName) {
            if (useInternalPath) return collection(db, 'artifacts', appId, 'public', 'data', colName);
            return collection(db, colName);
        }
        function getDocRef(colName, docId) {
            if (useInternalPath) return doc(db, 'artifacts', appId, 'public', 'data', colName, docId);
            return doc(db, colName, docId);
        }

        // --- AUTH ---
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) { console.error("Auth", error); }
        }

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                startListeners();
            }
        });

        // --- DATA LISTENERS ---
        function startListeners() {
            // Listen to Barbers
            onSnapshot(getCollection(BARBERS_COL), (snapshot) => {
                const temp = [];
                snapshot.forEach(doc => temp.push({ id: doc.id, ...doc.data() }));
                barbersData = temp;
                renderBarberGrid(); // Update Home Screen
                if(loggedInMode === 'admin') renderAdminList(); // Update Admin Screen
                
                // If currently selected barber became inactive, go home
                if (selectedBarber && !loggedInMode) {
                    const freshBarber = barbersData.find(b => b.id === selectedBarber.id);
                    if (!freshBarber || !freshBarber.isActive) {
                        alert("Este barbeiro encerrou o expediente.");
                        goHome();
                    }
                }
            });

            // Listen to Queue
            onSnapshot(getCollection(QUEUE_COL), (snapshot) => {
                const temp = [];
                snapshot.forEach(doc => temp.push({ id: doc.id, ...doc.data() }));
                
                queueData = temp
                    .filter(item => item.status !== 'done' && item.status !== 'cancelled')
                    .sort((a, b) => a.joinedAt - b.joinedAt);

                if (selectedBarber) renderQueue();
                renderBarberGrid(); // <--- CORREÇÃO: Atualiza os cards da home também!
            });
        }

        // --- UI NAVIGATION ---
        window.goHome = () => {
            if (loggedInMode) return; // Prevent logging out by accident if clicking title
            selectedBarber = null;
            document.getElementById('viewSelection').classList.remove('hidden');
            document.getElementById('viewQueue').classList.add('hidden');
            document.getElementById('viewAdmin').classList.add('hidden');
            document.getElementById('headerContext').innerText = "";
        };

        window.selectBarber = (barberId) => {
            const barber = barbersData.find(b => b.id === barberId);
            if (!barber) return;

            selectedBarber = barber;
            document.getElementById('viewSelection').classList.add('hidden');
            document.getElementById('viewQueue').classList.remove('hidden');
            
            // Set Titles
            document.getElementById('queueBarberName').innerText = barber.name;
            document.getElementById('displayBarberName').innerText = barber.name;
            document.getElementById('headerContext').innerText = `Vendo: ${barber.name}`;

            renderQueue();
        };

        // --- QUEUE LOGIC ---
        window.addToQueue = async () => {
            const name = document.getElementById('clientName').value.trim();
            if (!name || !selectedBarber) return;
            
            const btn = document.getElementById('joinBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            try {
                await addDoc(getCollection(QUEUE_COL), {
                    name: name,
                    status: 'waiting',
                    joinedAt: Date.now(),
                    createdBy: currentUser.uid,
                    barberId: selectedBarber.id // Critical: Link to barber
                });
                document.getElementById('clientName').value = '';
                const msg = document.getElementById('joinMessage');
                msg.classList.remove('hidden');
                setTimeout(() => msg.classList.add('hidden'), 3000);
            } catch (e) { console.error(e); alert("Erro ao entrar."); }
            finally { 
                btn.disabled = false; 
                btn.innerHTML = '<i class="fa-solid fa-ticket"></i> Pegar Senha';
            }
        };

        // --- ADMIN & BARBER LOGIN ---
        window.openLoginModal = () => {
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('pinInput').value = '';
            document.getElementById('pinInput').focus();
        };

        window.closeLoginModal = () => {
            document.getElementById('loginModal').classList.add('hidden');
        };

        window.processLogin = () => {
            const pin = document.getElementById('pinInput').value;
            
            // 1. Check Master Admin
            if (pin === MASTER_PIN) {
                loggedInMode = 'admin';
                document.getElementById('viewSelection').classList.add('hidden');
                document.getElementById('viewQueue').classList.add('hidden');
                document.getElementById('viewAdmin').classList.remove('hidden');
                document.getElementById('adminBtn').classList.add('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');
                document.getElementById('headerContext').innerText = "MODO ADMIN";
                closeLoginModal();
                renderAdminList();
                return;
            }

            // 2. Check Barber PIN
            const barber = barbersData.find(b => b.pin === pin);
            if (barber) {
                loggedInMode = 'barber';
                loggedInBarberId = barber.id;
                
                // Set as selected automatically
                selectedBarber = barber;
                
                // Hide Home, Show Queue
                document.getElementById('viewSelection').classList.add('hidden');
                document.getElementById('viewQueue').classList.remove('hidden');
                document.getElementById('viewAdmin').classList.add('hidden');
                
                // Adjust UI for Barber
                document.getElementById('customerPanel').classList.add('hidden'); // Hide entry form
                document.getElementById('adminBtn').classList.add('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');
                document.getElementById('headerContext').innerText = `Painel: ${barber.name}`;
                
                document.getElementById('displayBarberName').innerText = barber.name + " (Você)";

                closeLoginModal();
                renderQueue(); // Will trigger visibility of controls
                return;
            }

            alert("PIN Incorreto ou Barbeiro não encontrado.");
        };

        window.logout = () => {
            loggedInMode = null;
            loggedInBarberId = null;
            selectedBarber = null;
            
            document.getElementById('adminBtn').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            document.getElementById('customerPanel').classList.remove('hidden');
            
            goHome();
        };

        // --- ADMIN FUNCTIONS ---
        window.addBarber = async () => {
            const name = document.getElementById('newBarberName').value.trim();
            const pin = document.getElementById('newBarberPin').value.trim();
            if (!name || !pin) return alert("Preencha nome e PIN");

            try {
                await addDoc(getCollection(BARBERS_COL), {
                    name, pin, isActive: true, createdAt: Date.now()
                });
                document.getElementById('newBarberName').value = '';
                document.getElementById('newBarberPin').value = '';
            } catch(e) { alert("Erro ao criar."); }
        };

        window.toggleBarberStatus = async (id, currentStatus) => {
            try {
                await updateDoc(getDocRef(BARBERS_COL, id), { isActive: !currentStatus });
            } catch(e) { console.error(e); }
        };

        window.deleteBarber = async (id) => {
            if(confirm("Tem certeza? Isso não apaga o histórico, mas remove o acesso.")) {
                await deleteDoc(getDocRef(BARBERS_COL, id));
            }
        };

        function renderAdminList() {
            const container = document.getElementById('adminBarberList');
            container.innerHTML = '';
            
            if (barbersData.length === 0) {
                container.innerHTML = '<p class="text-slate-500">Nenhum barbeiro cadastrado.</p>';
                return;
            }

            barbersData.forEach(b => {
                const item = document.createElement('div');
                item.className = 'bg-slate-700 p-4 rounded-lg flex justify-between items-center';
                item.innerHTML = `
                    <div>
                        <div class="font-bold text-white text-lg">${b.name}</div>
                        <div class="text-xs text-slate-400">PIN: ${b.pin}</div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <span class="text-xs uppercase font-bold ${b.isActive ? 'text-emerald-400' : 'text-slate-500'}">${b.isActive ? 'Ativo' : 'Inativo'}</span>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="toggle" id="toggle-${b.id}" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-500 transition-all duration-300 ${b.isActive ? 'right-0 border-emerald-500' : 'left-0'}" 
                                onclick="toggleBarberStatus('${b.id}', ${b.isActive})"/>
                                <label for="toggle-${b.id}" class="toggle-label block overflow-hidden h-6 rounded-full cursor-pointer ${b.isActive ? 'bg-emerald-500' : 'bg-slate-600'}"></label>
                            </div>
                        </div>
                        <button onclick="deleteBarber('${b.id}')" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // --- RENDERERS ---
        function renderBarberGrid() {
            const grid = document.getElementById('barberGrid');
            const activeBarbers = barbersData.filter(b => b.isActive);
            grid.innerHTML = '';

            if (activeBarbers.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center py-10">
                    <i class="fa-solid fa-store-slash text-4xl text-slate-600 mb-4"></i>
                    <p class="text-slate-400">Nenhum profissional disponível no momento.</p>
                </div>`;
                return;
            }

            activeBarbers.forEach(b => {
                // Calculate queue for this barber for the preview
                const count = queueData.filter(q => q.barberId === b.id && q.status === 'waiting').length;
                const time = count * 20;

                const card = document.createElement('div');
                card.onclick = () => selectBarber(b.id);
                card.className = "bg-slate-800 border border-slate-700 hover:border-amber-500 p-6 rounded-2xl cursor-pointer transition transform hover:scale-105 shadow-lg group";
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="bg-slate-700 p-3 rounded-full text-amber-500 group-hover:bg-amber-500 group-hover:text-white transition">
                            <i class="fa-solid fa-user-tie text-2xl"></i>
                        </div>
                        <div class="text-right">
                            <span class="block text-2xl font-bold text-white">${count}</span>
                            <span class="text-xs text-slate-500 uppercase">Na Fila</span>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-1">${b.name}</h3>
                    <p class="text-emerald-400 text-sm font-medium"><i class="fa-regular fa-clock mr-1"></i> ~${time} min espera</p>
                `;
                grid.appendChild(card);
            });
        }

        function renderQueue() {
            if (!selectedBarber) return;

            const listContainer = document.getElementById('queueList');
            const activeContainer = document.getElementById('activeCutContainer');
            
            // Filter Queue specifically for this barber
            const myQueue = queueData.filter(item => item.barberId === selectedBarber.id);
            const activeClient = myQueue.find(item => item.status === 'cutting');
            const waitingClients = myQueue.filter(item => item.status === 'waiting');

            // Update Header Stats
            document.getElementById('statWaiting').innerText = waitingClients.length;
            document.getElementById('statWaitingMobile').innerText = waitingClients.length;
            const time = waitingClients.length * 20;
            document.getElementById('statAvgMobile').innerText = time + "m";
            document.getElementById('statAvgDesktop').innerText = time;

            // Render Active Client
            if (activeClient) {
                activeContainer.classList.remove('hidden');
                document.getElementById('activeClientName').innerText = activeClient.name;
                
                // Show finish button only if logged in as barber OR admin
                const controls = activeContainer.querySelectorAll('.barber-controls');
                controls.forEach(c => {
                    if (loggedInMode === 'admin' || (loggedInMode === 'barber' && loggedInBarberId === selectedBarber.id)) {
                        c.classList.remove('hidden');
                    } else {
                        c.classList.add('hidden');
                    }
                });
                
                // Attach functions globally for HTML onclick
                window.finishCut = async () => updateStatus(activeClient.id, 'done');

            } else {
                activeContainer.classList.add('hidden');
            }

            // Render Waiting List
            listContainer.innerHTML = '';
            if (waitingClients.length === 0 && !activeClient) {
                listContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-slate-600 fade-in">
                        <i class="fa-solid fa-mug-hot text-5xl mb-4 opacity-30"></i>
                        <p class="text-lg">Tudo calmo para ${selectedBarber.name}.</p>
                    </div>
                `;
            } else {
                waitingClients.forEach((client, index) => {
                    const card = document.createElement('div');
                    card.className = `bg-slate-800 border border-slate-700 rounded-xl p-4 mb-3 flex justify-between items-center shadow-sm fade-in status-waiting`;
                    
                    // Controls visibility logic
                    const showControls = loggedInMode === 'admin' || (loggedInMode === 'barber' && loggedInBarberId === selectedBarber.id);
                    
                    card.innerHTML = `
                        <div class="flex items-center gap-4 flex-1">
                            <div class="flex items-center justify-center w-10 h-10 rounded-full bg-slate-700 text-slate-400 font-bold">
                                ${index + 1}
                            </div>
                            <div>
                                <h4 class="font-bold text-lg text-white">${client.name}</h4>
                                <span class="text-xs text-slate-500"><i class="fa-regular fa-clock"></i> ${new Date(client.joinedAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                            </div>
                        </div>
                        ${showControls ? `
                        <div class="flex gap-2 ml-4">
                            <button onclick="callClient('${client.id}')" class="bg-amber-500 hover:bg-amber-600 text-white p-3 rounded-lg shadow"><i class="fa-solid fa-bell"></i></button>
                            <button onclick="removeClient('${client.id}')" class="bg-slate-700 hover:bg-red-500/80 text-white p-3 rounded-lg"><i class="fa-solid fa-trash"></i></button>
                        </div>` : ''}
                    `;
                    listContainer.appendChild(card);
                });
            }
        }

        // Global Actions
        window.callClient = async (id) => {
            if(confirm("Chamar cliente?")) updateStatus(id, 'cutting');
        };
        window.removeClient = async (id) => {
            if(confirm("Remover da fila?")) updateStatus(id, 'cancelled');
        };

        async function updateStatus(docId, newStatus) {
            try { await updateDoc(getDocRef(QUEUE_COL, docId), { status: newStatus }); }
            catch(e) { console.error(e); }
        }

        // Init
        initAuth();

    </script>
</body>
</html>
