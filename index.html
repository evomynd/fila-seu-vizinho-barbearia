// Estado da aplicaÃ§Ã£o
const state = {
    currentUser: null,
    selectedBarber: null,
    selectedDate: null,
    barbers: [],
    currentMonth: new Date(),
    isAdmin: false
};

// Elementos do DOM
const screens = {
    login: document.getElementById('loginScreen'),
    main: document.getElementById('mainScreen'),
    calendar: document.getElementById('calendarScreen'),
    admin: document.getElementById('adminScreen')
};

// InicializaÃ§Ã£o
document.addEventListener('DOMContentLoaded', () => {
    initAuth();
    setupEventListeners();
    registerServiceWorker();
});

// ==================== AUTENTICAÃ‡ÃƒO ====================

function initAuth() {
    // Verificar se houve redirect do Google
    auth.getRedirectResult().then(result => {
        if (result.user) {
            console.log('Login com Google bem-sucedido');;
        }
    }).catch(error => {
        console.error('Erro no redirect:', error);
        alert('Erro ao fazer login: ' + error.message);
    });

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            state.currentUser = user;
            await checkAdminStatus(user.uid);
            await loadBarbers();
            showScreen('main');
        } else {
            state.currentUser = null;
            showScreen('login');
        }
    });
}

async function checkAdminStatus(uid) {
    try {
        const doc = await db.collection('admins').doc(uid).get();
        state.isAdmin = doc.exists;
        
        // Mostrar/ocultar botÃ£o admin
        document.getElementById('adminMenuBtn').style.display = 
            state.isAdmin ? 'block' : 'none';
    } catch (error) {
        console.error('Erro ao verificar admin:', error);
        state.isAdmin = false;
    }
}

// Login com Google
document.getElementById('googleLoginBtn').addEventListener('click', async () => {
    try {
        showSpinner(true);
        await auth.signInWithRedirect(googleProvider);
    } catch (error) {
        alert('Erro ao fazer login: ' + error.message);
    } finally {
        showSpinner(false);
    }
});

// Login com Email/Senha
document.getElementById('emailLoginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    
    try {
        showSpinner(true);
        await auth.signInWithEmailAndPassword(email, password);
    } catch (error) {
        if (error.code === 'auth/user-not-found') {
            // Criar conta se nÃ£o existir
            if (confirm('Conta nÃ£o encontrada. Deseja criar uma nova conta?')) {
                try {
                    await auth.createUserWithEmailAndPassword(email, password);
                } catch (createError) {
                    alert('Erro ao criar conta: ' + createError.message);
                }
            }
        } else {
            alert('Erro ao fazer login: ' + error.message);
        }
    } finally {
        showSpinner(false);
    }
});

// Alternar entre login e registro
document.getElementById('showRegister').addEventListener('click', (e) => {
    e.preventDefault();
    const form = document.getElementById('emailLoginForm');
    const btn = form.querySelector('button[type="submit"]');
    const link = document.getElementById('showRegister');
    
    if (btn.textContent === 'Entrar') {
        btn.textContent = 'Criar Conta';
        link.textContent = 'JÃ¡ tenho conta';
    } else {
        btn.textContent = 'Entrar';
        link.textContent = 'Criar conta';
    }
});

// Logout
function logout() {
    auth.signOut();
}

document.getElementById('logoutBtn').addEventListener('click', logout);
document.getElementById('logoutBtn2').addEventListener('click', logout);
document.getElementById('logoutBtn3').addEventListener('click', logout);

// ==================== NAVEGAÃ‡ÃƒO ====================

function showScreen(screenName) {
    Object.values(screens).forEach(screen => screen.classList.remove('active'));
    screens[screenName].classList.add('active');
}

function setupEventListeners() {
    document.getElementById('adminMenuBtn').addEventListener('click', () => {
        if (state.isAdmin) {
            loadAdminPanel();
            showScreen('admin');
        } else {
            alert('Acesso negado. Apenas administradores.');
        }
    });
    
    document.getElementById('backToMainBtn').addEventListener('click', () => {
        showScreen('main');
    });
    
    document.getElementById('backFromAdminBtn').addEventListener('click', () => {
        showScreen('main');
    });
    
    document.getElementById('changeDateBtn').addEventListener('click', () => {
        document.getElementById('queueInfo').classList.add('hidden');
    });
}

// ==================== CABELEIREIROS ====================

async function loadBarbers() {
    try {
        const snapshot = await db.collection('barbers').orderBy('name').get();
        state.barbers = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
        
        renderBarbers();
    } catch (error) {
        console.error('Erro ao carregar cabeleireiros:', error);
    }
}

function renderBarbers() {
    const container = document.getElementById('barberButtons');
    container.innerHTML = '';
    
        if (state.barbers.length === 0) {
        container.innerHTML = '<p style="color: #C9B896; text-align: center;">Nenhum cabeleireiro cadastrado ainda.</p>';
        return;
    }    state.barbers.forEach(barber => {
        const card = document.createElement('div');
        card.className = 'barber-card';
        card.innerHTML = `
            <div class="icon">ðŸ’ˆ</div>
            <h4>${barber.name}</h4>
        `;
        card.addEventListener('click', () => selectBarber(barber));
        container.appendChild(card);
    });
}

function selectBarber(barber) {
    state.selectedBarber = barber;
    document.getElementById('selectedBarberName').textContent = barber.name;
    renderCalendar();
    showScreen('calendar');
}

// ==================== CALENDÃRIO ====================

function renderCalendar() {
    const year = state.currentMonth.getFullYear();
    const month = state.currentMonth.getMonth();
    
    // Atualizar tÃ­tulo
    const monthNames = ['Janeiro', 'Fevereiro', 'MarÃ§o', 'Abril', 'Maio', 'Junho',
                       'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    document.getElementById('currentMonth').textContent = 
        `${monthNames[month]} ${year}`;
    
    // Calcular dias
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();
    
    const container = document.getElementById('calendarDays');
    container.innerHTML = '';
    
    // Dias do mÃªs anterior
    for (let i = firstDay - 1; i >= 0; i--) {
        const day = daysInPrevMonth - i;
        const dayEl = createDayElement(day, 'other-month');
        container.appendChild(dayEl);
    }
    
    // Dias do mÃªs atual
    const today = new Date();
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dayEl = createDayElement(day, '');
        
        // Marcar hoje
        if (date.toDateString() === today.toDateString()) {
            dayEl.classList.add('today');
        }
        
        // Verificar disponibilidade
        if (!isBarberAvailable(date)) {
            dayEl.classList.add('disabled');
        } else if (date < today && date.toDateString() !== today.toDateString()) {
            dayEl.classList.add('disabled');
        } else {
            dayEl.addEventListener('click', () => selectDate(date));
        }
        
        container.appendChild(dayEl);
    }
    
    // Dias do prÃ³ximo mÃªs
    const totalCells = container.children.length;
    const remainingCells = 42 - totalCells; // 6 semanas
    for (let day = 1; day <= remainingCells; day++) {
        const dayEl = createDayElement(day, 'other-month');
        container.appendChild(dayEl);
    }
}

function createDayElement(day, className) {
    const div = document.createElement('div');
    div.className = `calendar-day ${className}`;
    div.textContent = day;
    return div;
}

function isBarberAvailable(date) {
    if (!state.selectedBarber.availability) return true;
    const dayOfWeek = date.getDay();
    return state.selectedBarber.availability.includes(dayOfWeek);
}

async function selectDate(date) {
    state.selectedDate = date;
    
    // Remover seleÃ§Ã£o anterior
    document.querySelectorAll('.calendar-day.selected').forEach(el => {
        el.classList.remove('selected');
    });
    
    // Marcar nova seleÃ§Ã£o
    event.target.classList.add('selected');
    
    // Buscar fila para esta data
    await loadQueueInfo(date);
}

async function loadQueueInfo(date) {
    try {
        showSpinner(true);
        
        const dateStr = date.toISOString().split('T')[0];
        const queueRef = db.collection('queues')
            .where('barberId', '==', state.selectedBarber.id)
            .where('date', '==', dateStr)
            .orderBy('position');
        
        const snapshot = await queueRef.get();
        const queueSize = snapshot.size;
        
        // Formatar data
        const dateFormatted = date.toLocaleDateString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
        
        document.getElementById('selectedDate').textContent = dateFormatted;
        document.getElementById('queuePosition').textContent = queueSize;
        document.getElementById('yourPosition').textContent = `${queueSize + 1}Âº`;
        document.getElementById('queueInfo').classList.remove('hidden');
        
    } catch (error) {
        console.error('Erro ao carregar fila:', error);
        alert('Erro ao carregar informaÃ§Ãµes da fila');
    } finally {
        showSpinner(false);
    }
}

// NavegaÃ§Ã£o do calendÃ¡rio
document.getElementById('prevMonth').addEventListener('click', () => {
    state.currentMonth.setMonth(state.currentMonth.getMonth() - 1);
    renderCalendar();
});

document.getElementById('nextMonth').addEventListener('click', () => {
    state.currentMonth.setMonth(state.currentMonth.getMonth() + 1);
    renderCalendar();
});

// ==================== FILA ====================

document.getElementById('joinQueueBtn').addEventListener('click', async () => {
    if (!state.selectedDate || !state.selectedBarber) return;
    
    try {
        showSpinner(true);
        
        const dateStr = state.selectedDate.toISOString().split('T')[0];
        
        // Verificar se jÃ¡ estÃ¡ na fila
        const existingQueue = await db.collection('queues')
            .where('barberId', '==', state.selectedBarber.id)
            .where('date', '==', dateStr)
            .where('userId', '==', state.currentUser.uid)
            .get();
        
        if (!existingQueue.empty) {
            alert('VocÃª jÃ¡ estÃ¡ na fila para esta data!');
            return;
        }
        
        // Obter posiÃ§Ã£o atual
        const queueSnapshot = await db.collection('queues')
            .where('barberId', '==', state.selectedBarber.id)
            .where('date', '==', dateStr)
            .get();
        
        const position = queueSnapshot.size + 1;
        
        // Adicionar Ã  fila
        await db.collection('queues').add({
            barberId: state.selectedBarber.id,
            barberName: state.selectedBarber.name,
            userId: state.currentUser.uid,
            userName: state.currentUser.displayName || state.currentUser.email,
            date: dateStr,
            position: position,
            status: 'waiting',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Mostrar modal com posiÃ§Ã£o
        showQueueModal(position - 1);
        
    } catch (error) {
        console.error('Erro ao entrar na fila:', error);
        alert('Erro ao entrar na fila');
    } finally {
        showSpinner(false);
    }
});

function showQueueModal(peopleAhead) {
    const modal = document.getElementById('queueModal');
    const counter = document.getElementById('counterValue');
    const progressCircle = document.getElementById('progressCircle');
    
    counter.textContent = peopleAhead;
    updateProgress(peopleAhead);
    modal.classList.add('active');
    
    // Escutar mudanÃ§as na fila em tempo real
    if (state.selectedDate && state.selectedBarber) {
        const dateStr = state.selectedDate.toISOString().split('T')[0];
        
        const unsubscribe = db.collection('queues')
            .where('barberId', '==', state.selectedBarber.id)
            .where('date', '==', dateStr)
            .where('userId', '==', state.currentUser.uid)
            .onSnapshot((snapshot) => {
                if (!snapshot.empty) {
                    const doc = snapshot.docs[0];
                    const data = doc.data();
                    const currentPosition = data.position;
                    
                    // Contar quantas pessoas estÃ£o na frente
                    db.collection('queues')
                        .where('barberId', '==', state.selectedBarber.id)
                        .where('date', '==', dateStr)
                        .where('position', '<', currentPosition)
                        .where('status', '==', 'waiting')
                        .get()
                        .then(queueSnapshot => {
                            const ahead = queueSnapshot.size;
                            counter.textContent = ahead;
                            updateProgress(ahead);
                            
                            if (ahead === 0) {
                                counter.textContent = 'ðŸŽ‰';
                                counter.nextElementSibling.textContent = 'Ã‰ a sua vez!';
                            }
                        });
                }
            });
        
        // Limpar listener ao fechar
        modal.dataset.unsubscribe = unsubscribe;
    }
}

function updateProgress(peopleAhead) {
    const circle = document.getElementById('progressCircle');
    const maxPeople = 20;
    const progress = Math.max(0, (maxPeople - peopleAhead) / maxPeople);
    const circumference = 2 * Math.PI * 85;
    const offset = circumference - (progress * circumference);
    circle.style.strokeDashoffset = offset;
}

document.getElementById('closeQueueModal').addEventListener('click', () => {
    const modal = document.getElementById('queueModal');
    
    // Parar de escutar mudanÃ§as
    if (modal.dataset.unsubscribe) {
        modal.dataset.unsubscribe();
        delete modal.dataset.unsubscribe;
    }
    
    modal.classList.remove('active');
    showScreen('main');
});

// ==================== PAINEL ADMIN ====================

async function loadAdminPanel() {
    await loadBarbersList();
    populateBarberSelect();
    setupAdminTabs();
}

function setupAdminTabs() {
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const tabName = btn.dataset.tab;
            
            tabBtns.forEach(b => b.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            
            btn.classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
        });
    });
}

// Adicionar cabeleireiro
document.getElementById('addBarberForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const name = document.getElementById('barberName').value.trim();
    if (!name) return;
    
    try {
        showSpinner(true);
        await db.collection('barbers').add({
            name: name,
            availability: [1, 2, 3, 4, 5], // Segunda a sexta por padrÃ£o
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        document.getElementById('barberName').value = '';
        await loadBarbersList();
        await loadBarbers();
        populateBarberSelect();
        
    } catch (error) {
        console.error('Erro ao adicionar cabeleireiro:', error);
        alert('Erro ao adicionar cabeleireiro');
    } finally {
        showSpinner(false);
    }
});

async function loadBarbersList() {
    try {
        const snapshot = await db.collection('barbers').orderBy('name').get();
        const container = document.getElementById('barbersList');
        container.innerHTML = '';
        
        snapshot.forEach(doc => {
            const barber = { id: doc.id, ...doc.data() };
            const item = document.createElement('div');
            item.className = 'item';
            item.innerHTML = `
                <span>${barber.name}</span>
                <div class="item-actions">
                    <button class="btn-small btn-danger" onclick="deleteBarber('${barber.id}')">
                        Excluir
                    </button>
                </div>
            `;
            container.appendChild(item);
        });
    } catch (error) {
        console.error('Erro ao carregar lista:', error);
    }
}

async function deleteBarber(barberId) {
    if (!confirm('Tem certeza que deseja excluir este cabeleireiro?')) return;
    
    try {
        showSpinner(true);
        await db.collection('barbers').doc(barberId).delete();
        await loadBarbersList();
        await loadBarbers();
        populateBarberSelect();
    } catch (error) {
        console.error('Erro ao excluir:', error);
        alert('Erro ao excluir cabeleireiro');
    } finally {
        showSpinner(false);
    }
}

// Tornar funÃ§Ã£o global para onclick
window.deleteBarber = deleteBarber;

// Gerenciar disponibilidade
function populateBarberSelect() {
    const select = document.getElementById('barberSelect');
    select.innerHTML = '<option value="">Selecione um cabeleireiro</option>';
    
    state.barbers.forEach(barber => {
        const option = document.createElement('option');
        option.value = barber.id;
        option.textContent = barber.name;
        select.appendChild(option);
    });
    
    select.addEventListener('change', loadBarberAvailability);
}

async function loadBarberAvailability() {
    const barberId = document.getElementById('barberSelect').value;
    if (!barberId) return;
    
    try {
        const doc = await db.collection('barbers').doc(barberId).get();
        if (doc.exists) {
            const availability = doc.data().availability || [];
            
            // Marcar checkboxes
            document.querySelectorAll('.weekdays-selector input[type="checkbox"]')
                .forEach(checkbox => {
                    checkbox.checked = availability.includes(parseInt(checkbox.value));
                });
        }
    } catch (error) {
        console.error('Erro ao carregar disponibilidade:', error);
    }
}

document.getElementById('saveAvailabilityBtn').addEventListener('click', async () => {
    const barberId = document.getElementById('barberSelect').value;
    if (!barberId) {
        alert('Selecione um cabeleireiro');
        return;
    }
    
    const availability = Array.from(
        document.querySelectorAll('.weekdays-selector input[type="checkbox"]:checked')
    ).map(cb => parseInt(cb.value));
    
    try {
        showSpinner(true);
        await db.collection('barbers').doc(barberId).update({
            availability: availability
        });
        
        await loadBarbers();
        alert('Disponibilidade salva com sucesso!');
        
    } catch (error) {
        console.error('Erro ao salvar disponibilidade:', error);
        alert('Erro ao salvar disponibilidade');
    } finally {
        showSpinner(false);
    }
});

// ==================== UTILITÃRIOS ====================

function showSpinner(show) {
    const spinner = document.getElementById('loadingSpinner');
    if (show) {
        spinner.classList.remove('hidden');
    } else {
        spinner.classList.add('hidden');
    }
}

// ==================== PWA ====================

function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js')
            .then(registration => {
                console.log('Service Worker registrado:', registration);
            })
            .catch(error => {
                console.log('Erro ao registrar Service Worker:', error);
            });
    }
}

// Prompt de instalaÃ§Ã£o
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    
    // Mostrar botÃ£o de instalaÃ§Ã£o customizado (opcional)
    console.log('App pode ser instalado');
});

window.addEventListener('appinstalled', () => {
    console.log('App instalado com sucesso');
    deferredPrompt = null;
});
